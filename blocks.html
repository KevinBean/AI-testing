<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markdown Note System</title>
  <!-- Checked above -->
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- jQuery UI CSS -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Checked above - CSS */
    body { padding: 20px; }
    .paragraph-block { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .docParagraph { resize: vertical; }
    .ui-autocomplete { z-index: 1050; }
    .sortable-placeholder { border: 1px dashed #aaa; background: #f8f9fa; height: 100px; margin-bottom: 10px; }
    .block-reference { font-weight: bold; color: #007bff; }
    .list-item { cursor: pointer; }
    .action-btn { font-size: 0.8em; margin-left: 5px; }
    /* New styles for better UI */
    .card { margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .card-header { background-color: #f8f9fa; font-weight: bold; }
    .help-tip { color: #6c757d; font-size: 0.9em; margin-bottom: 10px; }
    .section-title { border-bottom: 1px solid #dee2e6; padding-bottom: 8px; margin-bottom: 15px; }
    [data-toggle="tooltip"] { cursor: help; }

    .list-group-item:hover { background-color: #f8f9fa; }
    /* Improved layout styling */
    .container {
      max-width: 100%; /* wider container */
    }
    .row > [class^="col-"] {
      padding: 15px; /* more space in columns */
    }
    /* Required label */
    .required-field::after {
      content: "*";
      color: #dc3545;
      margin-left: 4px;
    }

    .highlight-paragraph {
      animation: highlight-fade 3s;
    }
    
    @keyframes highlight-fade {
      0% { background-color: rgba(255, 255, 0, 0.5); }
      100% { background-color: transparent; }
    }

    /* Enhanced Tag Tree Styling */
    .tag-tree { 
      list-style-type: none; 
      padding-left: 5px;
      margin-bottom: 5px;
    }
    .tag-tree-root { 
      padding-left: 0; 
      border-left: none;
    }
    .tag-tree-item { 
      display: flex; 
      align-items: center; 
      margin-bottom: 5px;
    }
    .tag-tree-toggle { 
      cursor: pointer; 
      transition: transform 0.2s;
      width: 15px;
      color: #6c757d;
    }
    .tag-tree-btn { 
      margin-left: 0px; 
      text-align: left;
      padding: 0.15rem 0.5rem;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
      transition: all 0.2s;
    }
    .tag-tree-btn:hover {
      transform: translateX(2px);
    }
    li .tag-tree {
      border-left: 1px dotted #dee2e6;
      padding-top: 5px;
      padding-bottom: 2px;
      margin-left: 10px; /* Add left margin to nested lists */
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Markdown Note System</h1>
    
    <div class="alert alert-info">
      This system helps you manage technical blocks, organize references, and create documents using Markdown formatting.
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="viewTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="blocks-tab" data-toggle="tab" href="#blocksView" role="tab">Blocks</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="references-tab" data-toggle="tab" href="#referencesView" role="tab">References</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="documents-tab" data-toggle="tab" href="#documentsView" role="tab">Documents</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="collections-tab" data-toggle="tab" href="#collectionsView" role="tab">Collections</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="tags-tab" data-toggle="tab" href="#tagsView" role="tab">Tags</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="actions-tab" data-toggle="tab" href="#actionsView" role="tab">Actions</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="workflows-tab" data-toggle="tab" href="#workflowsView" role="tab">Workflows</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="settings-tab" data-toggle="tab" href="#settingsView" role="tab">Settings</a>
      </li>
    </ul>

    
    <div class="tab-content">
      <!-- Blocks View Checked -->
      <div class="tab-pane fade show active" id="blocksView" role="tabpanel">
        <div class="row">
          <div class="col-md-3">
            <!-- Add New Block -->
            <div class="mb-2">
              <button id="addBlockBtn" class="btn btn-primary btn-block mt-3">Add New Block</button>
            </div>
            <!-- Blocks Search-->
            <div class="mb-2">
              <input type="text" id="blockSearch" class="form-control" placeholder="Search blocks...">
              <small class="form-text text-muted">Search by content, tags, or reference ID</small>
            </div>
            <!-- Blocks List -->
            <div class="section-title">Saved Blocks <small>(Click on Edit to modify a block)</small></div>
            <ul id="blockList" class="list-group"></ul>
          </div>
          
          <div class = "col-md-9">
            <!-- Middle column (preview) -->
            <div class="row-md-3">
              <!-- Block Details View Container -->
              <div id="blockDetailView"></div>
            </div>
            <!-- Middle column (editor) -->
            <div class="row-md-3">
              <div class="card mb-4">
                <div class="card-header">Block Management</div>
                <div class="card-body">
                  <div class="help-tip">
                    <p><strong>What are Blocks?</strong> Blocks are reusable pieces of technical content written in Markdown that can be organized into references and referenced in documents.</p>
                  </div>
                  <form id="blockForm">
                    <div class="form-group">
                      <label for="blockTitle" class="required-field">Block Title</label>
                      <a href="#" data-toggle="tooltip" title="A short descriptive title for this block"><i class="fas fa-question-circle"></i></a>
                      <input type="text" id="blockTitle" class="form-control" placeholder="Enter block title" required>
                    </div>
                    <div class="form-group">
                      <label for="blockText" class="required-field">Block Text (Markdown)</label>
                      <a href="#" data-toggle="tooltip" title="Use Markdown formatting: **bold**, *italic*, etc."><i class="fas fa-question-circle"></i></a>
                      <textarea id="blockText" class="form-control docParagraph" rows="6" placeholder="Enter block text in Markdown" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="blockNotes">Notes</label>
                      <a href="#" data-toggle="tooltip" title="Private notes for this block (not included in exports/references)"><i class="fas fa-question-circle"></i></a>
                      <textarea id="blockNotes" class="form-control" rows="2" placeholder="Enter optional notes about this block"></textarea>
                    </div>
                    <div class="row">
                      <div class="col-md-8">
                        <label for="blockTags">Tags</label>
                        <a href="#" data-toggle="tooltip" title="Separate tags with commas to help with searching"><i class="fas fa-question-circle"></i></a>
                        <input type="text" id="blockTags" class="form-control" placeholder="power, safety">
                      </div>
                      <div class="col-md-4">
                        <label for="blockReference" class="required-field">Reference (ID)</label>
                        <a href="#" data-toggle="tooltip" title="Use the autocomplete to select a valid reference"><i class="fas fa-question-circle"></i></a>
                        <input type="text" id="blockReference" class="form-control" placeholder="Select a reference" required>
                      </div>
                    </div>
                    <div class="row mt-3">
                      <div class="col-md-8">
                        <label>Reference Levels (L1â€“L6)</label>
                        <a href="#" data-toggle="tooltip" title="Enter numbers to define the block's position in the reference hierarchy"><i class="fas fa-question-circle"></i></a>
                        <div class="form-row">
                          <div class="col-2"><input type="number" id="blockLevel1" class="form-control" placeholder="L1"></div>
                          <div class="col-2"><input type="number" id="blockLevel2" class="form-control" placeholder="L2"></div>
                          <div class="col-2"><input type="number" id="blockLevel3" class="form-control" placeholder="L3"></div>
                          <div class="col-2"><input type="number" id="blockLevel4" class="form-control" placeholder="L4"></div>
                          <div class="col-2"><input type="number" id="blockLevel5" class="form-control" placeholder="L5"></div>
                          <div class="col-2"><input type="number" id="blockLevel6" class="form-control" placeholder="L6"></div>
                        </div>
                      </div>
                      <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-block">Add Block</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- references View -->
      <div class="tab-pane fade" id="referencesView" role="tabpanel">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-2">
              <button id="addReferenceBtn" class="btn btn-primary btn-block">Add New Reference</button>
            </div>
            <div class="mb-2">
              <input type="text" id="refSearch" class="form-control" placeholder="Search references...">
              <small class="form-text text-muted">Click on a reference to view all its blocks</small>
            </div>
            <div class="section-title">Saved References</div>
            <ul id="referenceList" class="list-group mb-3"></ul>
          </div>
          <div class="col-md-9">
            <div class="row-md-3">
              <div id="referenceCombinedView"></div>
            </div>
            <div class="row-md-3">
              <div class="card mb-4">
                <div class="card-header">Reference Metadata Management</div>
                <div class="card-body">
                  <div class="help-tip">
                    <p><strong>What are References?</strong> References are citations to references, papers, reports, or other documents. First create a reference, then add blocks to it.</p>
                  </div>
                  <form id="referenceForm" class="mb-3">
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="refId" class="required-field">Reference ID</label>
                        <a href="#" data-toggle="tooltip" title="Use a unique identifier for this reference"><i class="fas fa-question-circle"></i></a>
                        <input type="text" id="refId" class="form-control" placeholder="Unique ID" required>
                      </div>
                      <div class="form-group col-md-6">
                        <label for="refType" class="required-field">Reference Type</label>
                        <select id="refType" class="form-control" required>
                          <option value="">Select Type...</option>
                          <option value="standard">Standard</option>
                          <option value="paper">Paper</option>
                          <option value="report">Report</option>
                          <option value="webpage">Web Page</option>
                          <option value="other">Other</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group col-md-12">
                        <label for="refName" class="required-field">Title</label>
                        <input type="text" id="refName" class="form-control" placeholder="Reference Title" required>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="refAuthor">Author(s)</label>
                        <input type="text" id="refAuthor" class="form-control" placeholder="Author names">
                      </div>
                      <div class="form-group col-md-3">
                        <label for="refYear">Year</label>
                        <input type="number" id="refYear" class="form-control" placeholder="Publication year">
                      </div>
                      <div class="form-group col-md-3">
                        <label for="refVersion">Version/Edition</label>
                        <input type="text" id="refVersion" class="form-control" placeholder="Version">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group col-md-12">
                        <label for="refUrl">URL</label>
                        <input type="url" id="refUrl" class="form-control" placeholder="https://example.com">
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="refDesc">Description</label>
                      <textarea id="refDesc" class="form-control" placeholder="Description" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                      <button type="submit" class="btn btn-primary">Add Reference</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Documents View -->
      <div class="tab-pane fade" id="documentsView" role="tabpanel">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-2">
              <button id="addDocumentBtn" class="btn btn-primary btn-block">Add New Document</button>
            </div>
            <div class="mb-3">
              <input type="text" id="docSearch" class="form-control" placeholder="Search documents...">
              <small class="form-text text-muted">Click on a document to preview it</small>
            </div>
            <div class="section-title">Saved Documents</div>
            <ul id="docList" class="list-group"></ul>
          </div>
          <div class="col-md-9">
            <div class="row-md-3">
                          
                <div id="docPreviewContent" class="card"></div>
              <div id="documentReferencesList" class="card"></div>
            </div>
            <div class="row-md-4">
              <div class="card mb-4">
                <div class="card-header">Document Creation</div>
                <div class="card-body">
                  <div class="help-tip">
                    <p><strong>What are Documents?</strong> Documents consist of paragraphs written in Markdown. You can reference blocks from your library in each paragraph.</p>
                  </div>
                  <form id="documentForm">
                    <div class="form-group">
                      <label for="docTitle" class="required-field">Document Title</label>
                      <input type="text" id="docTitle" class="form-control" placeholder="Document Title" required>
                    </div>
                    <div class="section-title">Paragraphs <small>(Drag to reorder)</small></div>
                    <div id="paragraphContainer" class="mb-3">
                      <!-- Paragraph blocks added dynamically -->
                    </div>
                    <div class="btn-group mb-3">
                      <button type="button" id="addParagraphButton" class="btn btn-secondary">Add Paragraph</button>
                      <button type="button" id="livePreviewBtn" class="btn btn-info">Live Preview</button>
                      <button type="submit" class="btn btn-success">Save Document</button>
                    </div>
                    <div class="help-tip">
                      <p><strong>Tips:</strong> Use the autocomplete to reference blocks by ID. Drag paragraphs to reorder them.</p>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Collections View -->
      <div class="tab-pane fade" id="collectionsView" role="tabpanel">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-2">
              <button id="addCollectionBtn" class="btn btn-primary btn-block mt-3">Add New Collection</button>
            </div>
            <div class="mb-2">
              <input type="text" id="collectionSearch" class="form-control" placeholder="Search collections...">
              <small class="form-text text-muted">Search by name or description</small>
            </div>
            <div class="section-title">Saved Collections</div>
            <ul id="collectionList" class="list-group"></ul>
          </div>
          <div class="col-md-9">
            <div class="row-md-5">
              <div id="collectionPreview" class="card mb-4">
              </div>
            </div>
            
            <div class="row-md-4">
              <div class="card mb-4">
                <div class="card-header">Collection Management</div>
                <div class="card-body">
                  <div class="help-tip mb-3">
                    <p><strong>What are Collections?</strong> Collections are custom groups of blocks and documents that you can organize for specific purposes or projects.</p>
                  </div>
                  <form id="collectionForm">
                    <div class="form-group">
                      <label for="collectionName" class="required-field">Collection Name</label>
                      <input type="text" class="form-control" id="collectionName" required>
                    </div>
                    <div class="form-group">
                      <label for="collectionDesc">Description</label>
                      <textarea class="form-control" id="collectionDesc" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                      <label for="collectionTags">Tags</label>
                      <input type="text" class="form-control" id="collectionTags" placeholder="comma, separated, tags">
                    </div>
                    <div class="form-group">
                      <label>Collection Items</label>
                      <div id="collectionItems" class="border rounded p-2 mb-2">
                        <p class="text-muted text-center mb-0">No items added yet</p>
                      </div>
                      <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary" id="addBlockToCollection">
                          <i class="fas fa-plus"></i> Add Block
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="addDocToCollection">
                          <i class="fas fa-plus"></i> Add Document
                        </button>
                      </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Collection</button>
                    <button type="button" class="btn btn-secondary" id="cancelCollectionBtn">Clear</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tags View -->
      <div class="tab-pane fade" id="tagsView" role="tabpanel">
        <div class="row">
          <div class="col-md-3">
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <input type="text" id="tagSearch" class="form-control" placeholder="Search or select a tag...">
                  <div class="input-group-append">
                    <button class="btn btn-primary" id="searchTagBtn">Search</button>
                  </div>
                </div>
                <small class="form-text text-muted">Click on a tag to see all content with that tag</small>
              </div>
            </div>

            <div id="tagTreeContainer" class="mb-4"></div>
            <div class="section-title">Popular Tags</div>
            <div id="tagCloud" class="mb-4"></div>
          </div>
          <div class="col-md-9">
            <div class="row-md-4">
              <div class="card mb-4">
                <div class="card-header">Tag Management</div>
                <div class="card-body">
                  <div class="help-tip">
                    <p><strong>What are Tags?</strong> Tags are labels that help you categorize and find content across blocks, references, and documents.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="row-md-5">
              <div class="row">
                <div class="card col-md-12">
                  <div class="card-header">Content Tagged with: <span id="selectedTagName">All Tags</span></div>
                  <ul class="nav nav-tabs" id="tagContentTabs" role="tablist">
                    <li class="nav-item">
                      <a class="nav-link active" id="tag-blocks-tab" data-toggle="tab" href="#tagBlocksContent" role="tab">Blocks</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" id="tag-documents-tab" data-toggle="tab" href="#tagDocumentsContent" role="tab">Documents</a>
                    </li>
                  </ul>
                  <div class="tab-content border border-top-0 p-3">
                    <div class="tab-pane fade show active" id="tagBlocksContent" role="tabpanel">
                      <div id="taggedBlocksList"></div>
                    </div>
                    <div class="tab-pane fade" id="tagDocumentsContent" role="tabpanel">
                      <div id="taggedDocumentsList"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Actions View -->
      <div class="tab-pane fade" id="actionsView" role="tabpanel">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-2">
              <button id="addActionBtn" class="btn btn-primary btn-block mt-3">Add New Action</button>
            </div>
            <div class="mb-2">
<input type="text" id="actionSearch" class="form-control" placeholder="Search actions...">
              <small class="form-text text-muted">Search by title, description, or tags</small>
            </div>
            <div class="section-title">Saved Actions <small>(Click to edit)</small></div>
            <ul id="actionsList" class="list-group mb-3"></ul>
          </div>
          <div class="col-md-9">
            <div class="row-md-5">
              <div id="actionPreview" class="card">
                <p class="text-muted">Select an action to preview its settings and prompt template.</p>
              </div>
              <div class="card">
                <div class="card-header">Action Testing</div>
                <div class="card-body">
                  <div class="form-group">
                    <label for="actionTestInput">Input Content</label>
                    <textarea id="actionTestInput" class="form-control" rows="4" placeholder="Enter content for the action to process..."></textarea>
                  </div>
                  <button id="runActionBtn" class="btn btn-primary" disabled>Select Content & Run Action</button>
                  <div id="actionResultContainer" class="mt-3">
                    <div class="alert alert-info">Results will appear here after running the action.</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row-md-4">
              <div class="card mb-4">
                <div class="card-header">Action Configuration</div>
                <div class="card-body">
                  <div class="help-tip mb-3">
                      <p><strong>What are Actions?</strong> Actions are AI-powered operations you can configure to process your content. Create custom prompts with specific models and settings. Learn more about available models <a href="https://platform.openai.com/docs/models" target="_blank">here</a>.</p>
                  </div>
                  <form id="actionForm">
                    <div class="form-group">
                      <label for="actionTitle" class="required-field">Title</label>
                      <input type="text" id="actionTitle" class="form-control" placeholder="Action name" required>
                    </div>
                    <div class="form-group">
                      <label for="actionDescription" class="required-field">Description (System Prompt)</label>
                      <textarea id="actionDescription" class="form-control" rows="2" placeholder="How should this action perform?" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="actionTags">Tags</label>
                      <input type="text" id="actionTags" class="form-control" placeholder="comma, separated, tags">
                    </div>
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="actionModel" class="required-field">AI Model</label>
                        <input type="text" id="actionModel" class="form-control" list="modelOptions" placeholder="Enter or select model" required>
                        <datalist id="modelOptions">
                          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                          <option value="gpt-4">GPT-4</option>
                          <option value="gpt-4o">GPT-4o</option>
                          <option value="gpt-4o-search-preview">GPT-4o Search Preview</option>
                        </datalist>
                      </div>
                      <div class="form-group col-md-6">
                        <label for="actionPurpose">Purpose</label>
                        <select id="actionPurpose" class="form-control">
                          <option value="generate">Generate Content</option>
                          <option value="modify">Modify Content</option>
                          <option value="analyze">Analyze Content</option>
                          <option value="synthesize">Synthesize Content</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group form-check">
                      <input type="checkbox" class="form-check-input" id="enableWebSearch">
                      <label class="form-check-label" for="enableWebSearch">Enable Web Search (if supported by model)</label>
                    </div>

                    <div class="form-group form-check">
                      <input type="checkbox" class="form-check-input" id="useTools">
                      <label class="form-check-label" for="useTools">Use Tools (functions Not Working Now)</label>
                    </div>

                    <div class="form-group" id="toolsDefinitionContainer" style="display:none;">
                      <label for="toolsDefinition">Tools Definition (JSON)</label>
                      <textarea id="toolsDefinition" class="form-control" rows="6" placeholder='Enter tool definitions JSON here'></textarea>
                      <small class="form-text text-muted">Define tools as JSON objects. Example provided in documentation.</small>
                    </div>

                    <div class="form-group">
                      <label for="actionTemperature">Temperature: <span id="tempValue">0.7</span></label>
                      <input type="range" class="form-control-range" id="actionTemperature" min="0" max="1" step="0.1" value="0.7">
                      <small class="form-text text-muted">
                        Lower values (0-0.3): More focused, deterministic outputs<br>
                        Medium values (0.4-0.7): Balanced creativity<br>
                        Higher values (0.8-1.0): More random, creative outputs
                      </small>
                    </div>
                    <div class="form-group">
                      <label for="actionPrompt" class="required-field">Prompt Template</label>
                      <div class="help-tip mb-2">
                        <p>Use <code>{content}</code> as placeholder for the input content</p>
                      </div>
                      <textarea id="actionPrompt" class="form-control" rows="6" placeholder="Write your prompt here. Use {content} where the input should go." required></textarea>
                    </div>
                    <button type="submit" id="saveActionBtn" class="btn btn-primary">Save Action</button>
                    <button type="button" id="cancelActionBtn" class="btn btn-secondary">Clear</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Workflows View -->
      <div class="tab-pane fade" id="workflowsView" role="tabpanel">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-2">
              <input type="text" id="workflowSearch" class="form-control" placeholder="Search workflows...">
              <small class="form-text text-muted">Search by name or description</small>
            </div>
            <div class="section-title">Saved Workflows</div>
            <ul id="workflowList" class="list-group"></ul>
          </div>
          <div class="col-md-5 preview-col">
            <div class="card mb-4">
              <div class="card-header">Workflow Preview</div>
              <div class="card-body">
                <div id="workflowPreview" class="border p-3">
                  <p class="text-muted">Select a workflow to preview its steps and configuration.</p>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">Workflow Testing</div>
              <div class="card-body">
                
                
                <div id="workflowResultContainer" class="mt-3">
                  <div class="alert alert-info">Results will appear here after running the workflow.</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4 editor-col">
            <div class="card mb-4">
              <div class="card-header">Workflow Configuration</div>
              <div class="card-body">
                <div class="help-tip mb-3">
                  <p><strong>What are Workflows?</strong> Workflows are sequences of actions that can be run together. Create pipelines of AI operations to process your content.</p>
                </div>
                <form id="workflowForm">
                  <div class="form-group">
                    <label for="workflowName" class="required-field">Workflow Name</label>
                    <input type="text" class="form-control" id="workflowName" required>
                  </div>
                  <div class="form-group">
                    <label for="workflowDesc">Description</label>
                    <textarea class="form-control" id="workflowDesc" rows="2"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="workflowSteps">Workflow Steps</label>
                    <div id="workflowSteps" class="border rounded p-2 mb-2">
                      <!-- Steps will be added here -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="addWorkflowStepBtn">
                      <i class="fas fa-plus"></i> Add Step
                    </button>
                  </div>
                  <button type="submit" id="saveWorkflowBtn" class="btn btn-primary">Save Workflow</button>
                  <button type="button" id="cancelWorkflowBtn" class="btn btn-secondary">Clear</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings View -->
      <div class="tab-pane fade" id="settingsView" role="tabpanel">
        <div class="row">
          <div class="col-md-10">
            <!-- OPENAI Settings Checked -->
            <div class="card mb-4">
              <div class="card-header">OpenAI API Settings</div>
              <div class="card-body">
                <div class="help-tip">
                  <p>Enter your OpenAI API key to enable AI actions with real responses.</p>
                </div>
                <form id="apiSettingsForm">
                  <div class="form-group">
                    <label for="apiKey">OpenAI API Key</label>
                    <div class="input-group">
                      <input type="password" id="apiKey" class="form-control" placeholder="sk-...">
                    </div>
                    <small class="form-text text-muted">Your API key is stored in your browser's local storage.</small>
                  </div>
                  <button type="submit" class="btn btn-primary">Save API Key</button>
                  <button type="button" id="clearApiKey" class="btn btn-outline-danger">Clear API Key</button>
                </form>
                <div class="mt-3" id="apiKeyStatus"></div>
              </div>
            </div>
            <!-- Import/Export Settings To be checked -->
            <div class="card mt-4">
              <div class="card-header">Import / Export Data</div>
              <div class="card-body">
                <div class="help-tip">
                  <p>Export your data to save a backup or import data from another instance of this application.</p>
                </div>
                <button id="exportBtn" class="btn btn-outline-info">Export Data</button>
                <input type="file" id="importFile" class="ml-2">
                <small class="form-text text-muted">Select a previously exported JSON file to import data</small>
              </div>
            </div>
            
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-5 pt-4 text-center text-muted border-top">
      <p><small>Markdown Note System v1.0 | <a href="#" data-toggle="modal" data-target="#helpModal">Help & Documentation</a></small></p>
    </footer>
  </div>

  <!-- Help Modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Help & Documentation</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h5>Getting Started</h5>
          <p>This system helps you manage technical content using three main components:</p>
          <ul>
            <li><strong>Blocks</strong> - Reusable pieces of technical content written in Markdown</li>
            <li><strong>References</strong> - Citations to references, papers, reports, or other documents</li>
            <li><strong>Documents</strong> - Complete documents composed of paragraphs that can reference your blocks</li>
          </ul>
          
          <h5>Markdown Tips</h5>
          <p>This system uses Markdown formatting:</p>
          <ul>
            <li><code>**text**</code> for <strong>bold text</strong></li>
            <li><code>*text*</code> for <em>italic text</em></li>
            <li><code># Heading</code> for headings (more # means smaller heading)</li>
            <li><code>- item</code> for bullet lists</li>
            <li><code>1. item</code> for numbered lists</li>
            <li><code>[link text](URL)</code> for links</li>
          </ul>
          
          <h5>Workflow Example</h5>
          <ol>
            <li>Create references in the References tab</li>
            <li>Create blocks in the Blocks tab and associate them with references</li>
            <li>Create documents that reference your blocks</li>
          </ol>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Import Options Modal -->
  <div class="modal fade" id="importOptionsModal" tabindex="-1" role="dialog" aria-labelledby="importOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importOptionsModalLabel">Import Options</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Choose how to handle the imported data:</p>
          <div class="form-group">
            <div class="custom-control custom-radio">
              <input type="radio" id="replaceOption" name="importOption" class="custom-control-input" value="replace" checked>
              <label class="custom-control-label" for="replaceOption">
                <strong>Replace</strong> - Overwrite existing entries with the same ID
              </label>
              <small class="form-text text-muted ml-4">Use this option if you're restoring from a backup.</small>
            </div>
          </div>
          <div class="form-group">
            <div class="custom-control custom-radio">
              <input type="radio" id="mergeOption" name="importOption" class="custom-control-input" value="merge">
              <label class="custom-control-label" for="mergeOption">
                <strong>Merge</strong> - Keep existing entries when there are conflicts
              </label>
              <small class="form-text text-muted ml-4">Use this option to combine data from multiple sources.</small>
            </div>
          </div>
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> The import process will handle <strong><span id="importItemCount">0</span></strong> items in total.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmImport">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Selection Modal for Actions -->
  <div class="modal fade" id="contentSelectionModal" tabindex="-1" role="dialog" aria-labelledby="contentSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contentSelectionModalLabel">Select Content for Action</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="alert alert-info action-selection-info">
              Please select content to process with this action.
            </div>
          </div>
          
          <ul class="nav nav-tabs" id="selectionTabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="blocks-selection-tab" data-toggle="tab" href="#blocksSelectionTab" role="tab">Blocks</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="paragraphs-selection-tab" data-toggle="tab" href="#paragraphsSelectionTab" role="tab">Paragraphs</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="tags-selection-tab" data-toggle="tab" href="#tagsSelectionTab" role="tab">Tags</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="references-selection-tab" data-toggle="tab" href="#referencesSelectionTab" role="tab">References</a>
            </li>
          </ul>
          
          <div class="tab-content mt-3">
            <!-- Existing Blocks Tab -->
            <div class="tab-pane fade show active" id="blocksSelectionTab" role="tabpanel">
              <div class="input-group mb-3">
                <input type="text" id="blockSelectionSearch" class="form-control" placeholder="Search blocks...">
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="button" id="searchBlocksSelectionBtn">
                    <i class="fas fa-search"></i> Search
                  </button>
                </div>
              </div>
              <div class="block-selection-list overflow-auto" style="max-height: 300px;">
                <!-- Blocks will be loaded here -->
                <div class="text-center py-3">
                  <i class="fas fa-spinner fa-spin"></i> Loading blocks...
                </div>
              </div>
            </div>
            
            <!-- Existing Paragraphs Tab -->
            <div class="tab-pane fade" id="paragraphsSelectionTab" role="tabpanel">
              <div class="input-group mb-3">
                <input type="text" id="docSelectionSearch" class="form-control" placeholder="Search documents...">
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="button" id="searchDocsSelectionBtn">
                    <i class="fas fa-search"></i> Search
                  </button>
                </div>
              </div>
              <div class="document-selection-list overflow-auto mb-3" style="max-height: 200px;">
                <!-- Documents will be loaded here -->
                <div class="text-center py-3">
                  <i class="fas fa-spinner fa-spin"></i> Loading documents...
                </div>
              </div>
              <h6>Paragraphs in selected document:</h6>
              <div class="paragraph-selection-list overflow-auto" style="max-height: 200px;">
                <p class="text-muted text-center">Select a document first</p>
                <!-- Paragraphs will be loaded here when a document is selected -->
              </div>
            </div>
            
            <!-- New Tags Tab -->
            <div class="tab-pane fade" id="tagsSelectionTab" role="tabpanel">
              <div class="row">
                <div class="col-md-5">
                  <div class="input-group mb-3">
                    <input type="text" id="tagSelectionSearch" class="form-control" placeholder="Search tags...">
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" type="button" id="searchTagsSelectionBtn">
                        <i class="fas fa-search"></i> Search
                      </button>
                    </div>
                  </div>
                  <div class="tag-selection-cloud mb-3 p-2 border rounded" style="min-height: 120px;">
                    <!-- Tags will be loaded here -->
                    <div class="text-center py-3">
                      <i class="fas fa-spinner fa-spin"></i> Loading tags...
                    </div>
                  </div>
                </div>
                <div class="col-md-7">
                  <h6>Content with selected tags:</h6>
                  <div class="tagged-items-list overflow-auto" style="max-height: 400px;">
                    <p class="text-muted text-center">Select a tag to see content</p>
                    <!-- Tagged items will be shown here -->
                  </div>
                </div>
              </div>
            </div>
            
            <!-- New References Tab -->
            <div class="tab-pane fade" id="referencesSelectionTab" role="tabpanel">
              <div class="row">
                <div class="col-md-5">
                  <div class="input-group mb-3">
                    <input type="text" id="referenceSelectionSearch" class="form-control" placeholder="Search references...">
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" type="button" id="searchReferencesSelectionBtn">
                        <i class="fas fa-search"></i> Search
                      </button>
                    </div>
                  </div>
                  <div class="reference-selection-list overflow-auto" style="max-height: 300px;">
                    <!-- References will be loaded here -->
                    <div class="text-center py-3">
                      <i class="fas fa-spinner fa-spin"></i> Loading references...
                    </div>
                  </div>
                </div>
                <div class="col-md-7">
                  <h6>Blocks in selected reference:</h6>
                  <div class="reference-blocks-list overflow-auto" style="max-height: 400px;">
                    <p class="text-muted text-center">Select a reference to see blocks</p>
                    <!-- Reference blocks will be shown here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-3">
            <h6>Selected items (<span id="selectedItemsCount">0</span>):</h6>
            <div id="selectedItemsList" class="border rounded p-2" style="min-height: 60px; max-height: 120px; overflow-y: auto;">
              <p class="text-muted text-center mb-0">No items selected</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmContentSelection">Apply & Run Action</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery, jQuery UI, Bootstrap JS, Popper -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- Font Awesome for icons -->
  <script src="https://kit.fontawesome.com/a076d05399.js"></script>

  <script>
    /**********************
     * Global Variables
     **********************/
    let editingBlockId = null;
    let editingDocumentId = null;
    let editingReferenceId = null; // for editing reference metadata
    let blockAutocomplete = [];
    let referenceAutocomplete = []; // for block form autocomplete
    let tagAutocomplete = []; // for tag autocomplete
    let selectedTag = null; // Currently selected tag for filtering
    let importedData = null; // Variable to store imported data temporarily
    let openaiApiKey = null; // Variable to store OpenAI API key
    let selectedActionId = null; // Currently selected action for running
    let selectedContentItems = []; // Array to store selected content items for actions

    // Initialize tooltips
    $(function () {
      $('[data-toggle="tooltip"]').tooltip();
      // Load API key from local storage if available
      openaiApiKey = localStorage.getItem('openai_api_key');
      updateApiKeyStatus();
    });

    $("#blockSearch").on("keyup", function() {
      const searchTerm = $(this).val().trim();
      loadBlocks(searchTerm);
    });

    $("#refSearch").on("keyup", function() {
      const searchTerm = $(this).val().trim();
      loadReferencesMetadata(searchTerm);
    });
    
    // Function to show a temporary notification
    function showNotification(message, type = 'success') {
      const notification = $(`<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>`);
      
      $(".container").prepend(notification);
      setTimeout(() => {
        notification.alert('close');
      }, 3000);
    }
    
    /**********************
     * IndexedDB Setup
     **********************/
    let db;
    const request = indexedDB.open("EnhancedNoteDB", 7); // Increment version for schema update
    request.onupgradeneeded = function(e) {
      db = e.target.result;
      
      // Only create stores if they don't already exist
      if (!db.objectStoreNames.contains("documents")) {
        db.createObjectStore("documents", { keyPath: "id", autoIncrement: true });
      }
      
      // Rename clauses store to blocks if needed
      if (db.objectStoreNames.contains("clauses") && !db.objectStoreNames.contains("blocks")) {
        // Get all clauses
        const tempStore = e.target.transaction.objectStore("clauses");
        const clauses = [];
        tempStore.openCursor().onsuccess = function(e) {
          const cursor = e.target.result;
          if(cursor) {
            clauses.push(cursor.value);
            cursor.continue();
          } else {
            // Delete old store and create new one
            db.deleteObjectStore("clauses");
            const blockStore = db.createObjectStore("blocks", { keyPath: "id", autoIncrement: true });
            blockStore.createIndex("tags", "tags", { unique: false, multiEntry: true });
            
            // Add clauses data to new store in next transaction
            const tx = db.transaction("blocks", "readwrite");
            const store = tx.objectStore("blocks");
            clauses.forEach(clause => {
              // Add title field to existing clauses
              clause.title = "Block " + clause.id; // Default title
              store.add(clause);
            });
          }
        };
      } else if (!db.objectStoreNames.contains("blocks")) {
        // Create blocks store if it doesn't exist
        const blockStore = db.createObjectStore("blocks", { keyPath: "id", autoIncrement: true });
        blockStore.createIndex("tags", "tags", { unique: false, multiEntry: true });
      }
      
      if (!db.objectStoreNames.contains("references")) {
        // Create or update references store with additional fields
        const refStore = db.createObjectStore("references", { keyPath: "id" });
        // No need to create indexes for simple lookup table
      }
      
      // Create actions store if it doesn't exist
      if (!db.objectStoreNames.contains("actions")) {
        const actionsStore = db.createObjectStore("actions", { keyPath: "id", autoIncrement: true });
        actionsStore.createIndex("tags", "tags", { unique: false, multiEntry: true });
      }

      // Create workflows store if it doesn't exist
      if (!db.objectStoreNames.contains("workflows")) {
        const workflowsStore = db.createObjectStore("workflows", { keyPath: "id", autoIncrement: true });
        workflowsStore.createIndex("name", "name", { unique: false });
      }

      // Create collections store if it doesn't exist
      if (!db.objectStoreNames.contains("collections")) {
        const collectionsStore = db.createObjectStore("collections", { keyPath: "id", autoIncrement: true });
        collectionsStore.createIndex("name", "name", { unique: false });
      }
    };
    request.onsuccess = function(e) {
      db = e.target.result;
      loadBlocks();
      loadReferencesMetadata();
      loadDocuments();
      loadActions(); // Load saved actions
      loadWorkflows(); // Load saved workflows
      loadCollections(); // Load saved collections
      updateBlockAutocomplete();
      updateReferenceAutocomplete();
      updateTagAutocomplete(); // Add tag autocomplete initialization
    };
    request.onerror = function(e) { console.error("DB error:", e.target.error); };


    /**
     * Creates a highlighted excerpt of text containing a search term
     * 
     * @param {string} fullText - The complete text to search within
     * @param {string} searchTerm - The term to search for and highlight
     * @param {number} contextSize - Number of characters to include before and after the match (default: 50)
     * @return {string} - Rendered HTML with highlighted search term and context, or the original text if no match
     */
    function getHighlightedSearchContext(fullText, searchTerm, contextSize = 50) {
      // If no search term or it's empty, return the original rendered text
      if (!searchTerm || searchTerm.trim() === "") {
        return marked.parse(fullText);
      }
      
      // Create a context window around the matched term
      const lowerText = fullText.toLowerCase();
      const lowerSearchTerm = searchTerm.toLowerCase();
      const matchIndex = lowerText.indexOf(lowerSearchTerm);
      
      if (matchIndex >= 0) {
        // Extract context (about contextSize chars before and after)
        const startPos = Math.max(0, matchIndex - contextSize);
        const endPos = Math.min(fullText.length, matchIndex + searchTerm.length + contextSize);
        let extractedText = fullText.substring(startPos, endPos);
        
        // Add ellipses if we're not showing from the beginning/end
        if (startPos > 0) extractedText = "..." + extractedText;
        if (endPos < fullText.length) extractedText += "...";
        
        // Highlight the matched term with mark tags
        const highlightRegex = new RegExp('(' + searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        const highlightedText = extractedText.replace(highlightRegex, '<mark>$1</mark>');
        
        // Render only the extracted part with highlight
        return marked.parse(highlightedText);
      }
      
      // If no match found, return the original rendered text
      return marked.parse(fullText);
    }

    /**********************
     * Block Management (Markdown) - Checked
     **********************/
    function updateBlockAutocomplete() {
      blockAutocomplete = [];
      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const block = cursor.value;
          const title = block.title || "Block " + block.id;
          blockAutocomplete.push({ label: title + " (ID:" + block.id + ") - " + block.text + " - " + block.notes, value: block.id });
          cursor.continue();
        }
      };
    }

    $("#addBlockBtn").on("click", function() {
      $("#blockForm")[0].reset();
      editingBlockId = null;
      $("#blockForm button[type=submit]").text("Add Block");
      $("#blockForm").show();
      $("#blockTitle").focus();
    });

    $("#blockForm").on("submit", function(e) {
      e.preventDefault();
      const title = $("#blockTitle").val().trim();
      const text = $("#blockText").val().trim();
      const notes = $("#blockNotes").val().trim(); // Get notes
      const tags = $("#blockTags").val().split(",").map(s => s.trim()).filter(s => s);
      // The reference must be selected from the autocomplete (i.e. a valid reference id)
      const reference = $("#blockReference").val().trim();
      let refLevels = [];
      for(let i=1; i<=6; i++){
        let val = $("#blockLevel"+i).val().trim();
        if(val !== "") { refLevels.push(parseInt(val)); } else { break; }
      }
      const transaction = db.transaction("blocks", "readwrite");
      const store = transaction.objectStore("blocks");
      // if editing an existing block, update it
      // else add a new block
      if(editingBlockId) {
        store.get(editingBlockId).onsuccess = function(e) {
          let block = e.target.result;
          block.title = title;
          block.text = text;
          block.notes = notes; // Update notes
          block.tags = tags;
          block.reference = reference;
          block.refLevels = refLevels;
          block.updated = new Date();
          store.put(block).onsuccess = function() {
            showNotification("Block updated successfully!");
            editingBlockId = null;
            $("#blockForm")[0].reset();
            $("#blockForm button[type=submit]").text("Add");
            loadBlocks();
            updateBlockAutocomplete();
          };
        };
      } else {
        const block = { title, text, notes, tags, reference, refLevels, created: new Date() };
        store.add(block).onsuccess = function() {
          showNotification("New block added!");
          $("#blockForm")[0].reset();
          loadBlocks();
          updateBlockAutocomplete();
        };
      }
    });

    function loadBlocks(searchTerm = "") {
      $("#blockList").empty();
      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if(cursor) {
          const block = cursor.value;
          const title = block.title || "Block " + block.id;
          const combinedText = (title + " " + block.text + " " + block.tags.join(" ") + " " + (block.reference || "")).toLowerCase();
          if(combinedText.indexOf(searchTerm.toLowerCase()) !== -1) {
            let renderedText = getHighlightedSearchContext(block.text, searchTerm);
            let display = "<strong>" + title + "</strong><br>" + renderedText;
            if(block.tags.length) display += " <span class='badge badge-info'>" + block.tags.join("</span> <span class='badge badge-info'>") + "</span><br>";
            if(block.reference) {
              display += " <span class='block-reference'>[[" + block.reference;
              if(block.refLevels && block.refLevels.length > 0) { display += " " + block.refLevels.join("."); }
              display += "]]</span>";
            }
            const li = $("<li>").addClass("list-group-item list-item").html(display);
            
            // New: make the entire list item clickable to show linked paragraphs
            li.on("click", function() {
              showBlockDetails(block);
            });
            
            $("#blockList").append(li);
          }
          cursor.continue();
        }
      };
    }

    function editBlock(block) {
      editingBlockId = block.id;
      $("#blockTitle").val(block.title || "");
      $("#blockText").val(block.text);
      $("#blockNotes").val(block.notes || ""); // Set notes
      $("#blockTags").val(block.tags.join(", "));
      $("#blockReference").val(block.reference);
      for(let i=1; i<=6; i++){
        $("#blockLevel"+i).val(block.refLevels && block.refLevels[i-1] !== undefined ? block.refLevels[i-1] : "");
      }
      $("#blockForm button[type=submit]").text("Update");
    }

    function deleteBlock(id) {
      if(confirm("Are you sure you want to delete this block?")) {
        const transaction = db.transaction("blocks", "readwrite");
        const store = transaction.objectStore("blocks");
        store.delete(id).onsuccess = function() {
          loadBlocks();
          updateBlockAutocomplete();
        };
      }
    }

    // New universal method to edit a block from anywhere in the UI
    function editBlockUniversal(blockId) {
      if (blockId) {
        const transaction = db.transaction("blocks", "readonly");
        const store = transaction.objectStore("blocks");
        
        store.get(parseInt(blockId)).onsuccess = function(e) {
          const block = e.target.result;
          if (block) {
            // Switch to blocks tab
            $('#viewTabs a[href="#blocksView"]').tab('show');
            
            // Edit the block
            editBlock(block);
            
            // Hide any block detail view that might be open
            $("#blockDetailView").hide();
            
            // Scroll to the edit form
            $('html, body').animate({
              scrollTop: $("#blockForm").offset().top - 100
            }, 500);
          } else {
            showNotification(`Block with ID ${blockId} not found`, "warning");
          }
        };
      }
    }


    // Enhanced function to show block details with referencing paragraphs
    function showBlockDetails(block) {
      let renderedText = marked.parse(block.text);
      const title = block.title || "Block " + block.id;
      
      let html = `
        <div class="card mb-3">
          <div class="card-header">
            <strong>${title}</strong> (ID: ${block.id})
            <div class="btn-group float-right">
              <button class="btn btn-sm btn-warning edit-block-btn" data-block-id="${block.id}">Edit</button>
              <button class="btn btn-sm btn-danger delete-block-btn">Delete</button>
            </div>
          </div>
          <div class="card-body">
            ${renderedText}

            <div class="mt-2"><strong>Notes:</strong> ${block.notes || "No notes available."}</div>
            
            ${block.tags && block.tags.length ? 
              `<div class="mt-2">Tags: ${block.tags.map(t => `<span class="badge badge-info mr-1">${t}</span>`).join('')}</div>` : ''}
            
            ${block.reference ? 
              `<div class="mt-2">Reference: ${block.reference} ${block.refLevels && block.refLevels.length > 0 ? 
                block.refLevels.join(".") : ""}</div>` : ''}
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">Paragraphs Referencing This Block</div>
          <div class="card-body" id="referencingParagraphsList">
            <div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading references...</div>
          </div>
        </div>
      `;
      
      // Insert the HTML into a modal or container
      $("#blockDetailView").html(html).show();
      
      // Set up close button handler
      $(".delete-block-btn").on("click", function(e) {
        e.stopPropagation(); 
        deleteBlock(block.id);
      });
      
      // Set up edit button handler
      $(".edit-block-btn").on("click", function() {
        editBlockUniversal($(this).data("block-id"));
      });
      
      // Find and display paragraphs that reference this block
      findParagraphsReferencingBlock(block.id, function(references) {
        const refList = $("#referencingParagraphsList");
        
        if (references.length === 0) {
          refList.html('<p class="text-muted">No paragraphs are referencing this block.</p>');
          return;
        }
        
        let listHtml = '<ul class="list-group">';
        references.forEach(ref => {
          listHtml += `
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Document:</strong> ${ref.docTitle} 
                  <br><strong>Paragraph:</strong> ${ref.paraIndex + 1}
                  <br>${marked.parse(ref.content)}
                </div>
                <button class="btn btn-sm btn-outline-primary view-document-btn" 
                        data-doc-id="${ref.docId}" data-para-index="${ref.paraIndex}">
                  View
                </button>
              </div>
            </li>
          `;
        });
        listHtml += '</ul>';
        
        refList.html(listHtml);
        
        // Add click handler for view buttons
        $(".view-document-btn").click(function() {
          const docId = $(this).data("doc-id");
          const paraIndex = $(this).data("para-index");
          
          // Load and display the document
          fetchDocumentById(docId, function(doc) {
            if (doc) {
              previewDocument(doc);
              $("#blockDetailView").hide();
              // Switch to the documents tab
              $('#viewTabs a[href="#documentsView"]').tab('show');
              
              // Highlight the referenced paragraph (optional)
              setTimeout(() => {
                const paraElement = $("#docPreviewContent .mb-3").eq(paraIndex);
                if (paraElement.length) {
                  paraElement.addClass("highlight-paragraph");
                  $('html, body').animate({
                    scrollTop: paraElement.offset().top - 100
                  }, 500);
                  setTimeout(() => paraElement.removeClass("highlight-paragraph"), 3000);
                }
              }, 500);
            }
          });
        });
      });
    }


    /**********************
     * Reference Metadata Management Checked
     **********************/
    function updateReferenceAutocomplete() {
      referenceAutocomplete = [];
      const transaction = db.transaction("references", "readonly");
      const store = transaction.objectStore("references");
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if(cursor) {
          const ref = cursor.value;
          referenceAutocomplete.push({ label: ref.id + " - " + ref.name + (ref.type ? ` (${ref.type})` : ""), value: ref.id });
          cursor.continue();
        } else {
          // Set the block form's reference autocomplete source to the updated list
          $("#blockReference").autocomplete({ source: referenceAutocomplete });
        }
      };
    }
    
    $("#addReferenceBtn").on("click", function() {
      $("#referenceForm")[0].reset();
      editingReferenceId = null;
      $("#refId").prop("disabled", false);
      $("#referenceForm button[type=submit]").text("Add Reference");
      $("#referenceForm").show();
      $("#refId").focus();
    });

    $("#referenceForm").on("submit", function(e) {
      e.preventDefault();
      const id = $("#refId").val().trim();
      const name = $("#refName").val().trim();
      const description = $("#refDesc").val().trim();
      const type = $("#refType").val();
      const author = $("#refAuthor").val().trim();
      const year = $("#refYear").val() ? parseInt($("#refYear").val()) : null;
      const version = $("#refVersion").val().trim();
      const url = $("#refUrl").val().trim();
      
      const transaction = db.transaction("references", "readwrite");
      const store = transaction.objectStore("references");
      if(editingReferenceId) {
        store.get(editingReferenceId).onsuccess = function(e) {
          let ref = e.target.result;
          ref.name = name;
          ref.description = description;
          ref.type = type;
          ref.author = author;
          ref.year = year;
          ref.version = version;
          ref.url = url;
          ref.updated = new Date();
          
          const reqUpdate = store.put(ref);
          reqUpdate.onsuccess = function() {
            showNotification("Reference updated successfully!");
            editingReferenceId = null;
            $("#referenceForm")[0].reset();
            $("#refId").prop("disabled", false);
            $("#referenceForm button[type=submit]").text("Add Reference");
            loadReferencesMetadata();
            updateReferenceAutocomplete();
          };
          reqUpdate.onerror = function(e) {
            console.error(e.target.error);
            alert("Error updating reference: " + e.target.error);
          };
        };
      } else {
        const ref = { 
          id, 
          name, 
          description, 
          type, 
          author, 
          year, 
          version, 
          url,
          created: new Date() 
        };
        const reqAdd = store.add(ref);
        reqAdd.onsuccess = function() {
          showNotification("New reference added!");
          $("#referenceForm")[0].reset();
          loadReferencesMetadata();
          updateReferenceAutocomplete();
        };
        reqAdd.onerror = function(e) {
          console.error(e.target.error);
          alert("Error adding reference: " + e.target.error);
        };
      }
    });

    function loadReferencesMetadata(searchTerm = "") {
      $("#referenceList").empty();
      const transaction = db.transaction("references", "readonly");
      const store = transaction.objectStore("references");
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if(cursor) {
          const ref = cursor.value;
          const searchableText = (
            ref.id + " " + 
            ref.name + " " + 
            (ref.description || "") + " " + 
            (ref.type || "") + " " + 
            (ref.author || "") +
            (ref.year ? ref.year.toString() : "")
          ).toLowerCase();
          
          if(searchTerm === "" || searchableText.indexOf(searchTerm.toLowerCase()) !== -1) {
            let displayText = `<strong>${ref.id} - ${ref.name}</strong>`;
            if(ref.type) displayText += ` <span class="badge badge-secondary">${ref.type}</span>`;
            if(ref.author) displayText += `<br><small>Author: ${ref.author}</small>`;
            if(ref.year) displayText += `<small> (${ref.year})</small>`;
            
            const li = $("<li>")
              .addClass("list-group-item list-item")
              .html(displayText)
              .click(function() { combineReference(ref.id); });
            $("#referenceList").append(li);
          }
          cursor.continue();
        }
      };
    }

    function editReference(ref) {
      editingReferenceId = ref.id;
      $("#refId").val(ref.id).prop("disabled", true);
      $("#refName").val(ref.name);
      $("#refDesc").val(ref.description || "");
      $("#refType").val(ref.type || "");
      $("#refAuthor").val(ref.author || "");
      $("#refYear").val(ref.year || "");
      $("#refVersion").val(ref.version || "");
      $("#refUrl").val(ref.url || "");
      $("#referenceForm button[type=submit]").text("Update Reference");
    }

    function deleteReference(id) {
      if(confirm("Are you sure you want to delete this reference?")) {
        const transaction = db.transaction("references", "readwrite");
        const store = transaction.objectStore("references");
        store.delete(id).onsuccess = function() {
          $("#refId").prop("disabled", false);
          loadReferencesMetadata();
          updateReferenceAutocomplete();
        };
      }
    }

    function combineReference(refId) {
      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      let blocksForReference = [];
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if(cursor) {
          const block = cursor.value;
          if(block.reference === refId) {
            blocksForReference.push(block);
          }
          cursor.continue();
        } else {
          blocksForReference.sort((a, b) => {
            let al = a.refLevels || [];
            let bl = b.refLevels || [];
            for(let i = 0; i < Math.max(al.length, bl.length); i++){
              let av = al[i] || 0;
              let bv = bl[i] || 0;
              if(av !== bv) return av - bv;
            }
            return 0;
          });
          const trans = db.transaction("references", "readonly");
          const refStore = trans.objectStore("references");
          refStore.get(refId).onsuccess = function(ev) {
            let refMeta = ev.target.result;
            const refTitle = (refMeta ? refMeta.name : "");
            let html = `<div class='card mb-3'>
                  <div class="card-header">
                    <strong>${refTitle}</strong>`;
            
            if (refMeta) {
              html += ` (ID: ${refMeta.id})
                    <div class="btn-group float-right">
                      <button class="btn btn-sm btn-warning edit-ref-btn" data-block-id="${refMeta.id}">Edit</button>
                      <button class="btn btn-sm btn-danger delete-ref-btn">Delete</button>
                    </div>
                  </div>
                <div class='card-body'>`;
              
              // Display reference metadata
              if (refMeta.type) html += `<p><strong>Type:</strong> ${refMeta.type}</p>`;
              if (refMeta.description) html += `<p><strong>Description:</strong> ${refMeta.description}</p>`;
              if (refMeta.author) html += `<p><strong>Author(s):</strong> ${refMeta.author}</p>`;
              if (refMeta.year) html += `<p><strong>Year:</strong> ${refMeta.year}</p>`;
              if (refMeta.version) html += `<p><strong>Version:</strong> ${refMeta.version}</p>`;
              if (refMeta.url) html += `<p><strong>URL:</strong> <a href="${refMeta.url}" target="_blank">${refMeta.url}</a></p>`;
              
              html += "</div></div>";
            }
            
            if (blocksForReference.length > 0) {
              html += `<div class='card mb-3'><div class="card-header">Associated Blocks</div><div class='card-body'><ul>`;
              blocksForReference.forEach(block => {
                let level = (block.refLevels && block.refLevels.length) ? block.refLevels.length : 1;
                let indent = (level - 1) * 20;
                html += "<li style='padding: 30px 20px; margin-left:" + indent + "px; list-style-type: none; border: 1px solid #ccc;'>";
                if(block.refLevels && block.refLevels.length > 0) {
                  html += "<strong>" + block.refLevels.join(".") + "</strong>";
                }
                html += ": <strong>" + (block.title || "Block " + block.id) + "</strong> - " + marked.parse(block.text);
                // Add tags if available
                if(block.tags && block.tags.length) {
                  html += " <span class='badge badge-info'>" + block.tags.join("</span> <span class='badge badge-info'>") + "</span>";
                }
                // Add notes if available
                if(block.notes) {
                  html += "<br><small>Notes: " + block.notes + "</small>";
                }
                html += `<div class="btn-group float-right"><button class="btn btn-sm btn-outline-primary edit-ref-block-btn ml-2" data-block-id="${block.id}">Edit</button></div>`;
                html += "</li>";
              });
              html += "</ul>";
            } else {
              html += "<p>No blocks associated with this reference.</p>";
            }
            html += "</div></div>";
            $("#referenceCombinedView").html(html);

            // Add event handler after HTML is inserted
            $(".edit-ref-block-btn").on("click", function() {
              const blockId = $(this).data("block-id");
              editBlockUniversal(blockId);
            });

            // Set up close button handler
      $(".delete-ref-btn").on("click", function(e) {
        e.stopPropagation(); deleteReference(refMeta.id);
      });
      
      // Set up edit button handler
      $(".edit-ref-btn").on("click", function() {
        e.stopPropagation(); editReference(refMeta);
      });
          };
        }
      };
    }

    /**********************
     * Document Creation & Editing (Markdown)
     **********************/
    const paragraphContainer = $("#paragraphContainer");
    paragraphContainer.sortable({ placeholder: "sortable-placeholder" });

    // Function to show document references based on referenced blocks
    function showDocumentReferences(doc) {
      // Container to collect unique references
      const uniqueReferences = new Set();
      // Counter to track async operations
      let pendingBlocks = 0;
      let referencesData = {};
      // Map to organize blocks by reference
      const blocksByReference = {};
      
      // If no document is provided, clear the references list
      if (!doc) {
        $("#documentReferencesList").html('<div class="alert alert-info">No document selected. Please select or create a document.</div>');
        return;
      }
      
      // Clear previous content and show loading message
      $("#documentReferencesList").html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading references...</div>');
      
      // Process each paragraph to find referenced blocks
      doc.paragraphs.forEach(para => {
        // Get block references (handle both old and new format)
        const blockRefs = para.blockRefs || (para.blockRef ? [para.blockRef] : []);
        
        if (blockRefs.length > 0) {
          pendingBlocks += blockRefs.length;
          
          // Process each block reference
          blockRefs.forEach(blockId => {
            const transaction = db.transaction("blocks", "readonly");
            const blockStore = transaction.objectStore("blocks");
            
            blockStore.get(parseInt(blockId)).onsuccess = function(event) {
              const block = event.target.result;
              
              if (block && block.reference) {
                uniqueReferences.add(block.reference);
                
                // Organize blocks by reference
                if (!blocksByReference[block.reference]) {
                  blocksByReference[block.reference] = [];
                }
                // Add block to the reference group if it's not already there
                if (!blocksByReference[block.reference].some(b => b.id === block.id)) {
                  blocksByReference[block.reference].push(block);
                }
                
                // Get reference details
                const refTransaction = db.transaction("references", "readonly");
                const refStore = refTransaction.objectStore("references");
                
                refStore.get(block.reference).onsuccess = function(e) {
                  const refData = e.target.result;
                  if (refData) {
                    referencesData[block.reference] = refData;
                  }
                  
                  pendingBlocks--;
                  if (pendingBlocks === 0) {
                    renderReferencesUI(uniqueReferences, referencesData, blocksByReference);
                  }
                };
              } else {
                pendingBlocks--;
                if (pendingBlocks === 0) {
                  renderReferencesUI(uniqueReferences, referencesData, blocksByReference);
                }
              }
            };
          });
        }
      });
      
      // If no blocks with references were found
      if (pendingBlocks === 0) {
        $("#documentReferencesList").html('<div class="alert alert-info">No references found in this document.</div>');
      }
    }

    // Helper function to render the references UI
    function renderReferencesUI(uniqueReferences, referencesData, blocksByReference) {
      if (uniqueReferences.size === 0) {
        $("#documentReferencesList").html('<div class="alert alert-info">No references found in this document.</div>');
        return;
      }
      
      let html = '<div class="card mb-3"><div class="card-header">Document References</div><div class="card-body">';
      html += '<p class="small text-muted">These references are used by blocks referenced in this document:</p>';
      html += '<div class="accordion" id="referencesAccordion">';
      
      let counter = 0;
      uniqueReferences.forEach(refId => {
        const refData = referencesData[refId] || { id: refId };
        const blocksForRef = blocksByReference[refId] || [];
        counter++;
        
        html += `
          <div class="card">
            <div class="card-header" id="heading${counter}">
              <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <button class="btn btn-link" type="button" data-toggle="collapse" 
                  data-target="#collapse${counter}" aria-expanded="true" aria-controls="collapse${counter}">
                  <strong>${refId}</strong>${refData.name ? ` - ${refData.name}` : ''}
                </button>
                <span>
                  <span class="badge badge-secondary">${blocksForRef.length} block${blocksForRef.length !== 1 ? 's' : ''}</span>
                  <button class="btn btn-sm btn-outline-secondary view-reference-btn ml-2" data-ref-id="${refId}">
                    <i class="fas fa-external-link-alt"></i> View Reference
                  </button>
                </span>
              </h5>
            </div>
            <div id="collapse${counter}" class="collapse hide" aria-labelledby="heading${counter}" data-parent="#referencesAccordion">
              <div class="card-body">
                ${refData.description ? `<p class="text-muted">${refData.description}</p>` : ''}
                <h6>Referenced Blocks:</h6>
                <ul class="list-group">`;
      
        // Sort blocks by levels if available
        blocksForRef.sort((a, b) => {
          let al = a.refLevels || [];
          let bl = b.refLevels || [];
          for(let i = 0; i < Math.max(al.length, bl.length); i++){
            let av = al[i] || 0;
            let bv = bl[i] || 0;
            if(av !== bv) return av - bv;
          }
          return 0;
        });
                
        blocksForRef.forEach(block => {
          const levelStr = block.refLevels && block.refLevels.length > 0 ? 
            `<span class="badge badge-primary mr-2">${block.refLevels.join(".")}</span>` : '';
          
          html += `
            <li class="list-group-item">
              <div>
                ${levelStr}<strong>${block.title || 'Block ' + block.id}</strong> (ID: ${block.id})
                <div class="btn-group float-right">
                  <button class="btn btn-sm btn-warning edit-ref-block-btn" data-block-id="${block.id}">Edit</button>
                  <button class="btn btn-sm btn-outline-info preview-ref-block-btn" data-block-id="${block.id}">
                    <i class="fas fa-eye-slash"></i> Hide Content
                  </button>
                </div>
              </div>
              <div class="block-preview-container-${block.id} mt-2">
                <div class="card">
                  <div class="card-body bg-light">
                    ${marked.parse(block.text)}
                    ${block.tags && block.tags.length ? 
                      `<div class="mt-2">${block.tags.map(t => `<span class="badge badge-info mr-1">${t}</span>`).join('')}</div>` : ''}
                  </div>
                </div>
              </div>
            </li>`;
        });
                
        html += `
                </ul>
              </div>
            </div>
          </div>`;
      });
      
      html += '</div></div></div>';
      $("#documentReferencesList").html(html);
      
      // Add event listeners to reference view buttons
      $(".view-reference-btn").on("click", function() {
        const refId = $(this).data("ref-id");
        // Show the reference details
        combineReference(refId);
        // Switch to the references tab
        $("#references-tab").tab('show');
      });
      
      // Add event listeners to block edit buttons
      $(".edit-ref-block-btn").on("click", function() {
        const blockId = $(this).data("block-id");
        editBlockUniversal(blockId);
      });
      
      // Add event listeners to block preview buttons
      $(".preview-ref-block-btn").on("click", function() {
        const blockId = $(this).data("block-id");
        const previewContainer = $(`.block-preview-container-${blockId}`);
        const $button = $(this);
        
        // Toggle preview
        if (previewContainer.is(":visible")) {
          previewContainer.slideUp();
          $button.html('<i class="fas fa-eye"></i> Show Content');
        } else {
          previewContainer.slideDown();
          $button.html('<i class="fas fa-eye-slash"></i> Hide Content');
        }
      });
    }

    $("#addDocumentBtn").on("click", function() {
      $("#documentForm")[0].reset();
      editingDocumentId = null;
      $("#documentForm button[type=submit]").text("Add Document");
      $("#documentForm").show();
      $("#docTitle").focus();
    });

    function addParagraph() {
      const block = $(`
        <div class="paragraph-block">
          <div class="btn-group btn-group-sm mb-2 float-right">
            <button type="button" class="btn btn-outline-secondary move-up-btn"><i class="fas fa-arrow-up"></i></button>
            <button type="button" class="btn btn-outline-secondary move-down-btn"><i class="fas fa-arrow-down"></i></button>
            <button type="button" class="btn btn-outline-danger remove-para-btn"><i class="fas fa-trash"></i></button>
          </div>
          <label>Paragraph Title</label>
          <input type="text" class="form-control paraTitle mb-2" placeholder="Enter paragraph title (optional)">
          <label>Paragraph Content (Markdown)</label>
          <textarea class="form-control docParagraph" rows="6" placeholder="Enter markdown content"></textarea>
          
          <div class="row mt-2">
            <div class="col-md-8">
              <label>Reference Blocks <small>(Multiple blocks can be referenced)</small></label>
              <div class="block-references-container">
                <div class="input-group mb-2">
                  <input type="text" class="blockRef form-control" placeholder="Reference block ID (autocomplete enabled)">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary preview-block-btn" type="button" title="Preview referenced block"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-outline-info inherit-tags-btn" type="button" title="Inherit tags from block"><i class="fas fa-tags"></i></button>
                    <button class="btn btn-outline-danger remove-ref-btn" type="button" title="Remove this reference"><i class="fas fa-times"></i></button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary add-block-ref-btn mt-1"><i class="fas fa-plus"></i> Add Another Block Reference</button>
              <small class="form-text text-muted">Enter block IDs to include references</small>
            </div>
            <div class="col-md-4">
              <label>Paragraph Tags</label>
              <input type="text" class="paraTags form-control" placeholder="tag1, tag2">
              <small class="form-text text-muted">Separate tags with commas</small>
            </div>
          </div>
        </div>
      `);
      paragraphContainer.append(block);
      
      // Set up autocomplete for blocks
      block.find(".blockRef").autocomplete({
        source: function(request, response) {
          const results = $.ui.autocomplete.filter(blockAutocomplete, request.term);
          response(results.slice(0, 10));
        },
        minLength: 1,
        select: function(event, ui) {
          $(this).val(ui.item.value);
          return false;
        }
      });
      
      // Add block reference button
      block.find(".add-block-ref-btn").click(function() {
        const refContainer = $(this).siblings('.block-references-container');
        const newRef = $(`
          <div class="input-group mb-2">
            <input type="text" class="blockRef form-control" placeholder="Reference block ID (autocomplete enabled)">
            <div class="input-group-append">
              <button class="btn btn-outline-secondary preview-block-btn" type="button" title="Preview referenced block"><i class="fas fa-eye"></i></button>
              <button class="btn btn-outline-info inherit-tags-btn" type="button" title="Inherit tags from block"><i class="fas fa-tags"></i></button>
              <button class="btn btn-outline-danger remove-ref-btn" type="button" title="Remove this reference"><i class="fas fa-times"></i></button>
            </div>
          </div>
        `);
        
        // Set up autocomplete for the new block reference
        newRef.find(".blockRef").autocomplete({
          source: function(request, response) {
            const results = $.ui.autocomplete.filter(blockAutocomplete, request.term);
            response(results.slice(0, 10));
          },
          minLength: 1,
          select: function(event, ui) {
            $(this).val(ui.item.value);
            return false;
          }
        });
        
        // Set up the remove button
        newRef.find(".remove-ref-btn").click(function() {
          $(this).closest('.input-group').remove();
        });
        
        // Set up preview button
        newRef.find(".preview-block-btn").click(previewBlockBtnHandler);
        
        // Set up inherit tags button
        newRef.find(".inherit-tags-btn").click(inheritTagsBtnHandler);
        
        refContainer.append(newRef);
      });
      
      // Set up autocomplete for tags
      block.find(".paraTags").autocomplete({
        source: function(request, response) {
          const term = request.term.split(/,\s*/).pop();
          const results = $.ui.autocomplete.filter(tagAutocomplete, term);
          response(results.slice(0, 10));
        },
        focus: function() {
          return false;
        },
        select: function(event, ui) {
          const terms = this.value.split(/,\s*/);
          terms.pop();
          terms.push(ui.item.value);
          terms.push("");
          this.value = terms.join(", ");
          return false;
        },
        minLength: 1
      });
      
      // Set up paragraph control buttons
      block.find(".move-up-btn").click(function() {
        let currentBlock = $(this).closest(".paragraph-block");
        let prevBlock = currentBlock.prev(".paragraph-block");
        if(prevBlock.length) {
          currentBlock.insertBefore(prevBlock);
        }
      });
      
      block.find(".move-down-btn").click(function() {
        let currentBlock = $(this).closest(".paragraph-block");
        let nextBlock = currentBlock.next(".paragraph-block");
        if(nextBlock.length) {
          currentBlock.insertAfter(nextBlock);
        }
      });
      
      block.find(".remove-para-btn").click(function() {
        if(confirm("Are you sure you want to remove this paragraph?")) {
          $(this).closest(".paragraph-block").remove();
        }
      });
      
      // Remove ref button handler
      block.find(".remove-ref-btn").click(function() {
        const container = $(this).closest('.block-references-container');
        // Only remove if there's more than one reference
        if (container.find('.input-group').length > 1) {
          $(this).closest('.input-group').remove();
        }
      });
      
      // Create handler functions for preview and inherit tags buttons
      const previewBlockBtnHandler = function() {
        const blockId = $(this).closest(".input-group").find(".blockRef").val();
        if(blockId) {
          fetchBlockById(parseInt(blockId), function(block) {
            if(block) {
              const previewHtml = `<div class="alert alert-info">
                <strong>Block ${blockId}: ${block.title || ''}</strong> ${marked.parse(block.text)}
                ${block.reference ? `<div><strong>Reference:</strong> ${block.reference} 
                ${block.refLevels && block.refLevels.length > 0 ? block.refLevels.join(".") : ""}</div>` : '' }
                ${block.tags && block.tags.length ? `<div><strong>Tags:</strong> ${block.tags.join(", ")}</div>` : '' }
              </div>`;
              
              $(this).closest(".paragraph-block").append(previewHtml);
              setTimeout(() => {
                $(this).closest(".paragraph-block").find(".alert").fadeOut('slow', function() {
                  $(this).remove();
                });
              }, 3000);
            } else {
              alert("Block not found!");
            }
          }.bind(this));
        } else {
          alert("Please enter a block ID first");
        }
      };
      
      const inheritTagsBtnHandler = function() {
        const blockId = $(this).closest(".input-group").find(".blockRef").val();
        if(blockId) {
          fetchBlockById(parseInt(blockId), function(block) {
            if(block && block.tags && block.tags.length) {
              const paraTagsInput = $(this).closest(".paragraph-block").find(".paraTags");
              const currentTags = paraTagsInput.val().split(/,\s*/).filter(t => t.trim());
              
              // Merge existing tags with block tags (no duplicates)
              const mergedTags = [...new Set([...currentTags, ...block.tags])];
              paraTagsInput.val(mergedTags.join(", "));
              
              showNotification("Tags inherited from block", "info");
            } else {
              alert("No tags found in the referenced block");
            }
          }.bind(this));
        } else {
          alert("Please enter a block ID first");
        }
      };
      
      // Set up paragraph control buttons
      block.find(".move-up-btn").click(function() {
        let currentBlock = $(this).closest(".paragraph-block");
        let prevBlock = currentBlock.prev(".paragraph-block");
        if(prevBlock.length) {
          currentBlock.insertBefore(prevBlock);
        }
      });
      
      block.find(".move-down-btn").click(function() {
        let currentBlock = $(this).closest(".paragraph-block");
        let nextBlock = currentBlock.next(".paragraph-block");
        if(nextBlock.length) {
          currentBlock.insertAfter(nextBlock);
        }
      });
      
      block.find(".remove-para-btn").click(function() {
        if(confirm("Are you sure you want to remove this paragraph?")) {
          $(this).closest(".paragraph-block").remove();
        }
      });
      
      // Set up remove reference button
      block.find(".remove-ref-btn").click(function() {
        const container = $(this).closest('.block-references-container');
        // Only remove if there's more than one reference
        if (container.find('.input-group').length > 1) {
          $(this).closest('.input-group').remove();
        }
      });
      
      // Set up preview button
      block.find(".preview-block-btn").click(function() {
        const blockId = $(this).closest(".paragraph-block").find(".blockRef").val();
        if(blockId) {
          fetchBlockById(parseInt(blockId), function(block) {
            if(block) {
              const previewHtml = `<div class="alert alert-info">
                <strong>Block ${blockId}: ${block.title || ''}</strong> ${marked.parse(block.text)}
                ${block.reference ? `<div><strong>Reference:</strong> ${block.reference} 
                ${block.refLevels && block.refLevels.length > 0 ? block.refLevels.join(".") : ""}</div>` : '' }
                ${block.tags && block.tags.length ? `<div><strong>Tags:</strong> ${block.tags.join(", ")}</div>` : '' }
              </div>`;
              
              $(this).closest(".paragraph-block").append(previewHtml);
              setTimeout(() => {
                $(this).closest(".paragraph-block").find(".alert").fadeOut('slow', function() {
                  $(this).remove();
                });
              }, 120000);
            } else {
              alert("Block not found!");
            }
          }.bind(this));
        } else {
          alert("Please enter a block ID first");
        }
      });
      
      // Inherit tags from referenced block
      block.find(".inherit-tags-btn").click(function() {
        const blockId = $(this).closest(".paragraph-block").find(".blockRef").val();
        if(blockId) {
          fetchBlockById(parseInt(blockId), function(block) {
            if(block && block.tags && block.tags.length) {
              const paraTagsInput = $(this).closest(".paragraph-block").find(".paraTags");
              const currentTags = paraTagsInput.val().split(/,\s*/).filter(t => t.trim());
              
              // Merge existing tags with block tags (no duplicates)
              const mergedTags = [...new Set([...currentTags, ...block.tags])];
              paraTagsInput.val(mergedTags.join(", "));
              
              showNotification("Tags inherited from block", "info");
            } else {
              alert("No tags found in the referenced block");
            }
          }.bind(this));
        } else {
          alert("Please enter a block ID first");
        }
      });
    }
    addParagraph();
    $("#addParagraphButton").on("click", addParagraph);

    $("#livePreviewBtn").on("click", function() {
      let previewHTML = "<h1>" + $("#docTitle").val() + "</h1>";
      let paragraphPreviews = [];
      let pendingPreviews = 0;
      
      $(".paragraph-block").each(function(i) {
        const content = $(this).find(".docParagraph").val();
        const paraTitle = $(this).find(".paraTitle").val().trim();
        
        // Get all block references in this paragraph
        const blockRefs = [];
        $(this).find(".blockRef").each(function() {
          const refVal = $(this).val().trim();
          if (refVal) {
            blockRefs.push(parseInt(refVal));
          }
        });
        
        // Get paragraph tags
        const tagsStr = $(this).find(".paraTags").val();
        const tags = tagsStr ? tagsStr.split(/,\s*/).filter(t => t.trim()) : [];
        
        // Start building the paragraph HTML
        const paraTitleHTML = paraTitle ? `<h4>${paraTitle} (Paragraph ${i+1})</h4>` : `<h4>Paragraph ${i+1}</h4>`;
        let paragraphHTML = `<div class="mb-3">${marked.parse(content)}`;
        
        // Display paragraph tags if present
        if(tags.length) {
          paragraphHTML += `<p><small>Tags: ${tags.map(t => `<span class="badge badge-info">${t}</span>`).join(' ')}</small></p>`;
        }
        
        // Save the index for ordering later
        const paragraphIndex = i;
        
        if(blockRefs.length > 0) {
          let blockHTML = '';
          let blocksProcessed = 0;
          
          // Increment pending previews counter for this paragraph's blocks
          pendingPreviews += blockRefs.length;
          
          blockRefs.forEach(function(blockRef) {
            paragraphHTML += `<p><em>Block Reference: ${blockRef}</em></p>`;
            
            fetchBlockById(blockRef, function(block) {
              if(block) {
                blockHTML += `<p class="text-info"><strong>${block.title || 'Block ' + block.id}:</strong> ${marked.parse(block.text)}` +
                  (block.reference ? ` <span class="block-reference">[Reference: ${block.reference}` +
                  (block.refLevels && block.refLevels.length > 0 ? " " + block.refLevels.join(".") : "") + `]</span>` : "") + 
                  (block.tags && block.tags.length ? ` <small>[Tags: ${block.tags.join(", ")}]</small>` : "") +
                  `<button class="btn btn-sm btn-warning edit-preview-block-btn ml-2" data-block-id="${block.id}">Edit</button></p>`;
              } else {
                blockHTML += `<p class="text-danger">Block with ID ${blockRef} not found</p>`;
              }
              
              blocksProcessed++;
              
              if(blocksProcessed === blockRefs.length) {
                paragraphHTML += blockHTML + "</div>";
                
                // Store the paragraph HTML at the correct index
                paragraphPreviews[paragraphIndex] = paragraphHTML;
                pendingPreviews -= blockRefs.length;
                
                // Once all previews are done, update the preview content
                if(pendingPreviews === 0) {
                  // Filter out any undefined entries and join the previews
                  const filteredPreviews = paragraphPreviews.filter(p => p !== undefined);
                  $("#docPreviewContent").html(previewHTML + filteredPreviews.join(''));

                  // Add event handler for edit buttons
                  $("#docPreviewContent").find(".edit-preview-block-btn").on("click", function() {
                    const blockId = $(this).data("block-id");
                    editBlockUniversal(blockId);
                  });
                }
              }
            });
          });
        } else {
          paragraphHTML += "</div>";
          paragraphPreviews[paragraphIndex] = paragraphHTML;
        }
      });
      
      // If there are no block references at all, update preview immediately
      if(pendingPreviews === 0) {
        // Filter out any undefined entries and join the previews
        const filteredPreviews = paragraphPreviews.filter(p => p !== undefined);
        $("#docPreviewContent").html(previewHTML + filteredPreviews.join(''));
      }
    });

    $("#documentForm").on("submit", function(e) {
      e.preventDefault();
      
      // Check if database is available
      if (!db || db.version === null) {
        showNotification("Database is not available. Please refresh the page.", "danger");
        return;
      }
      
      const title = $("#docTitle").val().trim();
      const paragraphs = [];
      $(".paragraph-block").each(function() {
        const content = $(this).find(".docParagraph").val();
        const paraTitle = $(this).find(".paraTitle").val().trim();
        
        // Collect all block references
        const blockRefs = [];
        $(this).find(".blockRef").each(function() {
          const refVal = $(this).val().trim();
          if (refVal) {
            blockRefs.push(parseInt(refVal));
          }
        });
        
        // Get paragraph tags
        const tagsStr = $(this).find(".paraTags").val();
        const tags = tagsStr ? tagsStr.split(/,\s*/).filter(t => t.trim()) : [];
        
        paragraphs.push({ 
          title: paraTitle, // Paragraph title
          content, 
          blockRefs: blockRefs.length > 0 ? blockRefs : [], // Array of block references
          tags: tags 
        });
      });
      
      try {
        const transaction = db.transaction("documents", "readwrite");
        
        transaction.onerror = function(event) {
          console.error("Transaction error:", event.target.error);
          showNotification("Error saving document: " + event.target.error.message, "danger");
        };
        
        const store = transaction.objectStore("documents");
        if(editingDocumentId) {
          store.get(editingDocumentId).onsuccess = function(e) {
            let doc = e.target.result;
            doc.title = title;
            doc.paragraphs = paragraphs;
            doc.updated = new Date();
            store.put(doc).onsuccess = function() {
              showNotification("Document updated successfully!");
              editingDocumentId = null;
              $("#documentForm")[0].reset();
              $("#documentForm button[type=submit]").text("Save Document");
              paragraphContainer.empty();
              addParagraph();
              loadDocuments();
            };
          };
        } else {
          store.add({ title, paragraphs, created: new Date() }).onsuccess = function() {
            showNotification("New document created!");
            $("#documentForm")[0].reset();
            paragraphContainer.empty();
            addParagraph();
            loadDocuments();
          };
        }
      } catch (err) {
        console.error("Database error:", err);
        showNotification("Failed to save document. The database might be closing or unavailable. Please try again after refreshing the page.", "danger");
      }
    });

    function loadDocuments(searchTerm = "") {
      $("#docList").empty();
      
      // Check if database is available
      if (!db || db.version === null) {
        $("#docList").append('<li class="list-group-item">Database not available. Please refresh the page.</li>');
        return;
      }
      
      try {
        const transaction = db.transaction("documents", "readonly");
        const store = transaction.objectStore("documents");
        store.openCursor().onsuccess = function(e) {
          const cursor = e.target.result;
          if(cursor) {
            const doc = cursor.value;
            let combinedContent = doc.title;
            doc.paragraphs.forEach(p => {
              combinedContent += " " + p.content.replace(/<[^>]+>/g, "");
            });
            if(combinedContent.toLowerCase().indexOf(searchTerm.toLowerCase()) !== -1) {
              const li = $(`<li class="list-group-item list-item">ID: ${doc.id} | ${doc.title}</li>`);
              li.click(function(){ previewDocument(doc); });
              $("#docList").append(li);
            }
            cursor.continue();
          }
        };
      } catch (err) {
        console.error("Database error:", err);
        $("#docList").append('<li class="list-group-item">Database not available. Please refresh the page.</li>');
      }
    }

    $("#docSearch").on("keyup", function() {
      const term = $(this).val().trim();
      loadDocuments(term);
    });

    function previewDocument(doc) {
      let html = "<div class='card-header'><strong>" + doc.title + "</strong>(ID:" + doc.id + ')<div class="btn-group float-right"><button class="btn btn-sm btn-warning edit-doc-btn">Edit</button><button class="btn btn-sm btn-danger delete-doc-btn">Delete</button></div></div>';
      doc.paragraphs.forEach((p, i) => {
        // Add paragraph title if available
        const paragraphTitle = p.title ? `<h5 class="mb-2">${p.title}</h5>` : `<strong>Paragraph ${i+1}</strong>`;
    
        html += `<div class="card-body"><div class="paragraph-header">${paragraphTitle}</div>${marked.parse(p.content)}`;

        
        // Display paragraph tags if present
        if(p.tags && p.tags.length) {
          html += `<p><small>Tags: ${p.tags.map(t => `<span class="badge badge-info">${t}</span>`).join(' ')}</small></p>`;
        }
        
        if(p.blockRef) {
          html += `<p><em>Block Reference: ${p.blockRef}</em></p>`;
          fetchBlockById(p.blockRef, function(block) {
            html += block ? `<p class="text-info"><strong>${block.title || 'Block ' + block.id}:</strong> ${marked.parse(block.text)}` +
              (block.reference ? ` <span class="block-reference">[Reference: ${block.reference}` +
              (block.refLevels && block.refLevels.length > 0 ? " " + block.refLevels.join(".") : "") + `]</span>` : "") + 
              (block.tags && block.tags.length ? ` <small>[Tags: ${block.tags.join(", ")}]</small>` : "") +
              `<button class="btn btn-sm btn-warning edit-doc-block-btn ml-2" data-block-id="${block.id}">Edit</button></p>` : `<p class="text-danger">Block not found</p>`;
            $("#docPreviewContent").html(html);
            
            // Add event handler for edit buttons
            $(".edit-doc-block-btn").on("click", function() {
              const blockId = $(this).data("block-id");
              editBlockUniversal(blockId);
            });
          });
        }
        
        html += "</div>";
      });
      $("#docPreviewContent").html(html);

      // Set up close button handler
      $(".delete-doc-btn").on("click", function(e) {
        e.stopPropagation(); deleteDocument(doc.id)
      });
      
      // Set up edit button handler
      $(".edit-doc-btn").on("click", function(e) {
        e.stopPropagation(); 
        editDocument(doc);
      });
      // Show document references whenever a document is previewed
      showDocumentReferences(doc);
    }

    function editDocument(doc) {
      editingDocumentId = doc.id;
      $("#docTitle").val(doc.title);
      paragraphContainer.empty();
      doc.paragraphs.forEach(p => {
        const block = $(`

          <div class="paragraph-block">
            <div class="btn-group btn-group-sm mb-2 float-right">
              <button type="button" class="btn btn-outline-secondary move-up-btn"><i class="fas fa-arrow-up"></i></button>
              <button type="button" class="btn btn-outline-secondary move-down-btn"><i class="fas fa-arrow-down"></i></button>
              <button type="button" class="btn btn-outline-danger remove-para-btn"><i class="fas fa-trash"></i></button>
            </div>
            <label>Paragraph Title</label>
            <input type="text" class="form-control paraTitle mb-2" placeholder="Enter paragraph title (optional)">
            <label>Paragraph Content (Markdown)</label>
            <textarea class="form-control docParagraph" rows="6" placeholder="Enter markdown content"></textarea>
            
            <div class="row mt-2">
              <div class="col-md-8">
                <label>Reference Blocks <small>(Multiple blocks can be referenced)</small></label>
                <div class="block-references-container">
                  <!-- Block references will be added here -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary add-block-ref-btn mt-1"><i class="fas fa-plus"></i> Add Another Block Reference</button>
                <small class="form-text text-muted">Enter block IDs to include references</small>
              </div>
              <div class="col-md-4">
                <label>Paragraph Tags</label>
                <input type="text" class="paraTags form-control" placeholder="tag1, tag2">
              </div>
            </div>
          </div>
        `);
        paragraphContainer.append(block);
        block.find(".docParagraph").val(p.content);

        block.find(".paraTitle").val(p.title || '');
        
        // Get block references (handle both old and new format)
        const blockRefs = p.blockRefs || (p.blockRef ? [p.blockRef] : []);
        
        // Create reference inputs for each block reference
        const refContainer = block.find('.block-references-container');
        
        if (blockRefs.length === 0) {
          // Add an empty reference field if none exist
          const emptyRef = $(`
            <div class="input-group mb-2">
              <input type="text" class="blockRef form-control" placeholder="Reference block ID (autocomplete enabled)">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary preview-block-btn" type="button" title="Preview referenced block"><i class="fas fa-eye"></i></button>
                <button class="btn btn-outline-info inherit-tags-btn" type="button" title="Inherit tags from block"><i class="fas fa-tags"></i></button>
                <button class="btn btn-outline-danger remove-ref-btn" type="button" title="Remove this reference"><i class="fas fa-times"></i></button>
              </div>
            </div>
          `);
          refContainer.append(emptyRef);
        } else {
          // Add a reference field for each existing reference
          blockRefs.forEach(ref => {
            const refField = $(`
              <div class="input-group mb-2">
                <input type="text" class="blockRef form-control" placeholder="Reference block ID (autocomplete enabled)" value="${ref}">
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary preview-block-btn" type="button" title="Preview referenced block"><i class="fas fa-eye"></i></button>
                  <button class="btn btn-outline-info inherit-tags-btn" type="button" title="Inherit tags from block"><i class="fas fa-tags"></i></button>
                  <button class="btn btn-outline-danger remove-ref-btn" type="button" title="Remove this reference"><i class="fas fa-times"></i></button>
                </div>
              </div>
            `);
            refContainer.append(refField);
          });
        }
        
        // Set paragraph tags if they exist
        if(p.tags && p.tags.length) {
          block.find(".paraTags").val(p.tags.join(", "));
        }
        
        // Set up autocomplete for all block references
        block.find(".blockRef").each(function() {
          $(this).autocomplete({
            source: function(request, response) {
              const results = $.ui.autocomplete.filter(blockAutocomplete, request.term);
              response(results.slice(0, 10));
            },
            minLength: 1,
            select: function(event, ui) {
              $(this).val(ui.item.value);
              return false;
            }
          });
        });
        
        // Add block reference button
        block.find(".add-block-ref-btn").click(function() {
          const refContainer = $(this).siblings('.block-references-container');
          const newRef = $(`
            <div class="input-group mb-2">
              <input type="text" class="blockRef form-control" placeholder="Reference block ID (autocomplete enabled)">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary preview-block-btn" type="button" title="Preview referenced block"><i class="fas fa-eye"></i></button>
                <button class="btn btn-outline-info inherit-tags-btn" type="button" title="Inherit tags from block"><i class="fas fa-tags"></i></button>
                <button class="btn btn-outline-danger remove-ref-btn" type="button" title="Remove this reference"><i class="fas fa-times"></i></button>
              </div>
            </div>
          `);
          
          // Set up autocomplete for the new block reference
          newRef.find(".blockRef").autocomplete({
            source: function(request, response) {
              const results = $.ui.autocomplete.filter(blockAutocomplete, request.term);
              response(results.slice(0, 10));
            },
            minLength: 1,
            select: function(event, ui) {
              $(this).val(ui.item.value);
              return false;
            }
          });
          
          // Set up preview button
          newRef.find(".preview-block-btn").click(previewBlockBtnHandler);
          
          // Set up inherit tags button
          newRef.find(".inherit-tags-btn").click(inheritTagsBtnHandler);
          
          // Set up remove button
          newRef.find(".remove-ref-btn").click(function() {
            $(this).closest('.input-group').remove();
          });
          
          refContainer.append(newRef);
        });
        
        // Set up tags autocomplete
        block.find(".paraTags").autocomplete({
          source: function(request, response) {
            const term = request.term.split(/,\s*/).pop();
            const results = $.ui.autocomplete.filter(tagAutocomplete, term);
            response(results.slice(0, 10));
          },
          focus: function() {
            return false;
          },
          select: function(event, ui) {
            const terms = this.value.split(/,\s*/);
            terms.pop();
            terms.push(ui.item.value);
            terms.push("");
            this.value = terms.join(", ");
            return false;
          },
          minLength: 1
        });
        
        // Define button handlers
        const previewBlockBtnHandler = function() {
          const blockId = $(this).closest(".input-group").find(".blockRef").val();
          if(blockId) {
            fetchBlockById(parseInt(blockId), function(block) {
              if(block) {
                const previewHtml = `<div class="alert alert-info">
                  <strong>Block ${blockId}: ${block.title || ''}</strong> ${marked.parse(block.text)}
                  ${block.reference ? `<div><strong>Reference:</strong> ${block.reference} 
                  ${block.refLevels && block.refLevels.length > 0 ? block.refLevels.join(".") : ""}</div>` : '' }
                  ${block.tags && block.tags.length ? `<div><strong>Tags:</strong> ${block.tags.join(", ")}</div>` : '' }
                </div>`;
                
                const paragraphBlock = $(this).closest(".paragraph-block");
                // Remove any existing previews
                paragraphBlock.find(".alert").remove();
                paragraphBlock.append(previewHtml);
                setTimeout(() => {
                  paragraphBlock.find(".alert").fadeOut('slow', function() {
                    $(this).remove();
                  });
                }, 3000);
              } else {
                alert("Block not found!");
              }
            }.bind(this));
          } else {
            alert("Please enter a block ID first");
          }
        };
        
        const inheritTagsBtnHandler = function() {
          const blockId = $(this).closest(".input-group").find(".blockRef").val();
          if(blockId) {
            fetchBlockById(parseInt(blockId), function(block) {
              if(block && block.tags && block.tags.length) {
                const paraTagsInput = $(this).closest(".paragraph-block").find(".paraTags");
                const currentTags = paraTagsInput.val().split(/,\s*/).filter(t => t.trim());
                
                // Merge existing tags with block tags (no duplicates)
                const mergedTags = [...new Set([...currentTags, ...block.tags])];
                paraTagsInput.val(mergedTags.join(", "));
                
                showNotification("Tags inherited from block", "info");
              } else {
                alert("No tags found in the referenced block");
              }
            }.bind(this));
          } else {
            alert("Please enter a block ID first");
          }
        };
        
        // Set up paragraph control buttons
        block.find(".move-up-btn").click(function() {
          let currentBlock = $(this).closest(".paragraph-block");
          let prevBlock = currentBlock.prev(".paragraph-block");
          if(prevBlock.length) {
            currentBlock.insertBefore(prevBlock);
          }
        });
        
        block.find(".move-down-btn").click(function() {
          let currentBlock = $(this).closest(".paragraph-block");
          let nextBlock = currentBlock.next(".paragraph-block");
          if(nextBlock.length) {
            currentBlock.insertAfter(nextBlock);
          }
        });
        
        block.find(".remove-para-btn").click(function() {
          if(confirm("Are you sure you want to remove this paragraph?")) {
            $(this).closest(".paragraph-block").remove();
          }
        });
        
        // Set up remove reference button
        block.find(".remove-ref-btn").click(function() {
          const container = $(this).closest('.block-references-container');
          // Only remove if there's more than one reference
          if (container.find('.input-group').length > 1) {
            $(this).closest('.input-group').remove();
          }
        });
        
        // Set up preview button
        block.find(".preview-block-btn").click(function() {
          const blockId = $(this).closest(".paragraph-block").find(".blockRef").val();
          if(blockId) {
            fetchBlockById(parseInt(blockId), function(block) {
              if(block) {
                const previewHtml = `<div class="alert alert-info">
                  <strong>Block ${blockId}: ${block.title || ''}</strong> ${marked.parse(block.text)}
                  ${block.reference ? `<div><strong>Reference:</strong> ${block.reference} 
                  ${block.refLevels && block.refLevels.length > 0 ? block.refLevels.join(".") : ""}</div>` : '' }
                  ${block.tags && block.tags.length ? `<div><strong>Tags:</strong> ${block.tags.join(", ")}</div>` : '' }
                </div>`;
                
                $(this).closest(".paragraph-block").append(previewHtml);
                setTimeout(() => {
                  $(this).closest(".paragraph-block").find(".alert").fadeOut('slow', function() {
                    $(this).remove();
                  });
                }, 3000);
              } else {
                alert("Block not found!");
              }
            }.bind(this));
          } else {
            alert("Please enter a block ID first");
          }
        });
        
        // Inherit tags from referenced block
        block.find(".inherit-tags-btn").click(function() {
          const blockId = $(this).closest(".paragraph-block").find(".blockRef").val();
          if(blockId) {
            fetchBlockById(parseInt(blockId), function(block) {
              if(block && block.tags && block.tags.length) {
                const paraTagsInput = $(this).closest(".paragraph-block").find(".paraTags");
                const currentTags = paraTagsInput.val().split(/,\s*/).filter(t => t.trim());
                
                // Merge existing tags with block tags (no duplicates)
                const mergedTags = [...new Set([...currentTags, ...block.tags])];
                paraTagsInput.val(mergedTags.join(", "));
                
                showNotification("Tags inherited from block", "info");
              } else {
                alert("No tags found in the referenced block");
              }
            }.bind(this));
          } else {
            alert("Please enter a block ID first");
          }
        });
      });
      $("#documentForm button[type=submit]").text("Update Document");
    }

    function fetchBlockById(id, callback) {
      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      store.get(id).onsuccess = function(e) { callback(e.target.result); };
    }

    // Helper function to fetch a document by ID
    function fetchDocumentById(id, callback) {
      const transaction = db.transaction("documents", "readonly");
      const store = transaction.objectStore("documents");
      store.get(id).onsuccess = function(e) { 
        callback(e.target.result); 
      };
    }

    // Function to find all paragraphs referencing a specific block
    function findParagraphsReferencingBlock(blockId, callback) {
      const referencingParagraphs = [];
      const transaction = db.transaction("documents", "readonly");
      const store = transaction.objectStore("documents");
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const doc = cursor.value;
          
          if (doc.paragraphs && doc.paragraphs.length > 0) {
            doc.paragraphs.forEach((para, paraIndex) => {
              // Check both old (blockRef) and new (blockRefs) formats
              const blockRefs = para.blockRefs || (para.blockRef ? [para.blockRef] : []);
              
              if (blockRefs.includes(blockId)) {
                referencingParagraphs.push({
                  docId: doc.id,
                  docTitle: doc.title,
                  paraIndex: paraIndex,
                  content: para.content.substring(0, 100) + (para.content.length > 100 ? '...' : '')
                });
              }
            });
          }
          cursor.continue();
        } else {
          // All documents have been processed
          callback(referencingParagraphs);
        }
      };
    }



    function deleteDocument(id) {
      if(confirm("Are you sure you want to delete this document?")) {
        const transaction = db.transaction("documents", "readwrite");
        const store = transaction.objectStore("documents");
        store.delete(id).onsuccess = function() {
          showNotification("Document deleted successfully!");
          loadDocuments();
        };
      }
    }

    /**********************
     * Tags Management
     **********************/
    // Function to build a tag tree from flat tag list
    function buildTagTree(tagCounts) {
      const tree = { name: 'root', children: {}, count: 0 };
      
      // Build the tree structure
      Object.keys(tagCounts).forEach(tag => {
        const count = tagCounts[tag];
        const parts = tag.split('/');
        
        // Handle both hierarchical and flat tags
        if (parts.length > 1) {
          // It's a hierarchical tag
          let currentLevel = tree;
          parts.forEach((part, idx) => {
            if (!currentLevel.children[part]) {
              currentLevel.children[part] = { name: part, children: {}, count: 0,
            // Store the path up to this level for navigation purposes
            path: parts.slice(0, idx + 1).join('/') };
            }
            
            // If it's a leaf node (final part of the path), add the count
            if (idx === parts.length - 1) {
              currentLevel.children[part].count += count;
              currentLevel.children[part].fullPath = tag;
            }
            
            // Increment parent counts to represent total items in branch
            currentLevel.count += count;
            
            // Move to next level
            currentLevel = currentLevel.children[part];
          });
        } else {
          // It's a flat tag
          if (!tree.children[tag]) {
            tree.children[tag] = { name: tag, children: {}, count: 0, fullPath: tag };
          }
          tree.children[tag].count += count;
          tree.count += count;
        }
      });
      
      return tree;
    }
    
    // Enhanced renderTagTree function with better support for deep nesting
    function renderTagTree(treeNode, container, level = 0) {
      const childrenKeys = Object.keys(treeNode.children).sort();
      if (childrenKeys.length === 0) return;
      
      // ðŸ‘‡ CHANGED: Each level should get its own UL for proper nesting
      const ul = $('<ul>').addClass('tag-tree');
      if (level === 0) ul.addClass('tag-tree-root');
      
      childrenKeys.forEach(key => {
        const child = treeNode.children[key];
        const hasChildren = Object.keys(child.children).length > 0;
        
        // ðŸ‘‡ CHANGED: Improved indent with more visual spacing per level
        const li = $('<li>').css('margin-left', `${level * 12}px`);
        
        // Visual indicator of hierarchy level
        const tagItem = $('<div>').addClass('tag-tree-item');
        
        // Add toggle icon for nodes with children
        if (hasChildren) {
          const toggleIcon = $('<i>').addClass('fas fa-caret-right tag-tree-toggle mr-1');
          tagItem.append(toggleIcon);
          
          // ðŸ‘‡ CHANGED: Improved toggle behavior to properly show/hide deeply nested children
          toggleIcon.click(function(e) {
            e.stopPropagation();
            const nestedUl = $(this).closest('li').children('ul').first();
            nestedUl.toggle();
            $(this).toggleClass('fa-caret-right fa-caret-down');
          });
        } else {
          // Add indentation for leaf nodes to align with parent toggles
          tagItem.append($('<i>').addClass('fas fa-tag mr-1 text-muted'));
        }
        
        // ðŸ‘‡ CHANGED: Visual enhancements to better show the tag hierarchy level
        const tagBtn = $('<button>')
          .addClass('btn btn-sm btn-outline-info tag-tree-btn')
          .text(child.name);
          
        // ðŸ‘‡ CHANGED: Better visual cue for depth with increasing color intensity
        if (level > 0) {
          // Gradient border color that gets darker with depth
          const opacity = Math.min(0.4 + (level * 0.15), 1.0);
          const hue = 180 + (level * 10); // Slight hue change by level
          tagBtn.css('border-left', `4px solid hsla(${hue}, 70%, 40%, ${opacity})`);
          
          // Add indentation marker to show the hierarchy
          tagBtn.prepend(`<span class="text-muted mr-1">${'â€¢'.repeat(level)}</span>`);
        }
        
        // Add count badge
        tagBtn.append($('<span>').addClass('badge badge-light ml-1').text(child.count));
        
        // Add click handler to trigger tag filtering
        if (child.fullPath) {
          tagBtn.click(function() {
            selectedTag = child.fullPath;
            $("#tagSearch").val(child.fullPath);
            $("#selectedTagName").text(child.fullPath);
            loadContentByTag(child.fullPath);
          });
        }
        
        tagItem.append(tagBtn);
        li.append(tagItem);
        
        // ðŸ‘‡ CHANGED: Recursively build child nodes with proper DOM nesting
        if (hasChildren) {
          const childUl = renderTagTree(child, li, level + 1);
          li.append(childUl);
          
          // ðŸ‘‡ CHANGED: Only hide deeper levels (3+) by default for better UX
          if (level >= 2) {
            childUl.hide();
          }
        }
        
        ul.append(li);
      });
      
      container.append(ul);
      return ul;
    }
    
    // Function to update the tag visualization
    function updateTagVisualization(tagCounts) {
      // Create the traditional tag cloud
      updateTagCloud(tagCounts);
      
      // Create hierarchical tag tree
      const tagTreeContainer = $("#tagTreeContainer");
      tagTreeContainer.empty();
      
      // Build and render the tree
      const tagTree = buildTagTree(tagCounts);
      
      // Add a heading
      const heading = $('<h5>').text('Tag Hierarchy').addClass('mb-3');
      tagTreeContainer.append(heading);
      
      renderTagTree(tagTree, tagTreeContainer);
      
      // Add info about usage
      const info = $('<div>').addClass('text-muted small mt-2')
        .html('<i class="fas fa-info-circle"></i> Use slashes to create hierarchical tags (e.g., "power/cables/rating")');
      tagTreeContainer.append(info);
    }

    // Function to update the tag autocomplete
    function updateTagAutocomplete() {
      tagAutocomplete = [];
      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      const tagCounts = {}; // To count tag frequency
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const block = cursor.value;
          if (block.tags && block.tags.length) {
            block.tags.forEach(tag => {
              if (tagCounts[tag]) {
                tagCounts[tag]++;
              } else {
                tagCounts[tag] = 1;
                tagAutocomplete.push(tag);
              }
            });
          }
          cursor.continue();
        } else {
          // After counting all tags, update the tag visualizations
          updateTagVisualization(tagCounts);
          
          // Set the tag autocomplete
          $("#tagSearch").autocomplete({
            source: tagAutocomplete,
            minLength: 1
          });
        }
      };
    }
    
    // Function to update the tag cloud (traditional flat view)
    function updateTagCloud(tagCounts) {
      const tagCloud = $("#tagCloud");
      tagCloud.empty();
      
      // Sort tags by frequency
      const sortedTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
      
      // Display top 20 tags
      sortedTags.slice(0, 20).forEach(tag => {
        const count = tagCounts[tag];
        // Scale font size between 1em and 2em based on frequency
        const fontSize = 1 + (count / Math.max(...Object.values(tagCounts))) * 1;
        
        const tagBtn = $(`<button class="btn btn-outline-info m-1">${tag} <span class="badge badge-light">${count}</span></button>`);
        tagBtn.css('font-size', `${fontSize}em`);
        tagBtn.click(function() {
          selectedTag = tag;
          $("#tagSearch").val(tag);
          $("#selectedTagName").text(tag);
          loadContentByTag(tag);
        });
        
        tagCloud.append(tagBtn);
      });
    }

    // Function to load blocks and documents by tag
    function loadContentByTag(tag) {
      const blocksList = $("#taggedBlocksList");
      blocksList.empty();
      
      const txBlocks = db.transaction("blocks", "readonly");
      const blockStore = txBlocks.objectStore("blocks");
      blockStore.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const block = cursor.value;
          if (block.tags && block.tags.includes(tag)) {
            let renderedText = marked.parse(block.text);
            const blockItem = $(`
              <div class="card mb-2">
                <div class="card-body">
                  <h6>${block.title || 'Block'} (ID: ${block.id})</h6>
                  <div>${renderedText}</div>
                  <div class="mt-2 d-flex justify-content-between">
                    <div>
                      ${block.tags.map(t => `<span class="badge badge-info mr-1">${t}</span>`).join('')}
                    </div>
                    <div>
                      <button class="btn btn-sm btn-warning edit-tag-block-btn" data-block-id="${block.id}">Edit</button>
                    </div>
                  </div>
                </div>
              </div>
            `);
            
            // Add event handler for the edit button
            blockItem.find(".edit-tag-block-btn").on("click", function() {
              const blockId = $(this).data("block-id");
              editBlockUniversal(blockId);
            });
            
            blocksList.append(blockItem);
          }
          cursor.continue();
        }
      };
      
      const documentsList = $("#taggedDocumentsList");
      documentsList.empty();
      
      const txDocs = db.transaction("documents", "readonly");
      const docStore = txDocs.objectStore("documents");
      docStore.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const doc = cursor.value;
          let hasTag = false;
          
          if (doc.paragraphs) {
            for (const para of doc.paragraphs) {
              if (para.tags && para.tags.includes(tag)) {
                hasTag = true;
                break;
              }
            }
          }
          
          if (hasTag) {
            const docItem = $(`
              <div class="card mb-2">
                <div class="card-body">
                  <h6>Document: ${doc.title}</h6>
                  <button class="btn btn-sm btn-outline-primary view-doc-btn" data-id="${doc.id}">View Document</button>
                </div>
              </div>
            `);
            
            docItem.find(".view-doc-btn").click(function() {
              previewDocument(doc);
              $('#viewTabs a[href="#documentsView"]').tab('show');
            });
            
            documentsList.append(docItem);
          }
          cursor.continue();
        }
      };
    }
    
    $("#searchTagBtn").click(function() {
      const tag = $("#tagSearch").val().trim();
      if (tag) {
        selectedTag = tag;
        $("#selectedTagName").text(tag);
        loadContentByTag(tag);
      }
    });
    
    $("#tagSearch").keypress(function(e) {
      if (e.which === 13) {
        $("#searchTagBtn").click();
      }
    });

    /**********************
     * Action Management
     **********************/
    let editingActionId = null;

    // Update temperature display when slider changes
    $("#actionTemperature").on("input", function() {
      $("#tempValue").text($(this).val());
    });

    // Load saved actions
    function loadActions(searchTerm = "") {
      $("#actionsList").empty();
      const transaction = db.transaction("actions", "readonly");
      const store = transaction.objectStore("actions");
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const action = cursor.value;
          const searchableText = (
            action.title + " " + 
            action.description + " " + 
            (action.tags ? action.tags.join(" ") : "")
          ).toLowerCase();
          
          if (!searchTerm || searchableText.indexOf(searchTerm.toLowerCase()) !== -1) {
            const li = $("<li>")
              .addClass("list-group-item list-item")
              .html(`<strong>${action.title}</strong><br><small>${action.description || ""}</small>`)
              .click(function() { previewAction(action); });
            
            if (action.tags && action.tags.length) {
              const tagsSpan = $("<div>")
                .addClass("mt-1")
                .html(action.tags.map(t => `<span class="badge badge-info mr-1">${t}</span>`).join(""));
              li.append(tagsSpan);
            }
            
            $("#actionsList").append(li);
          }
          cursor.continue();
        }
      };
    }
    
    $("#actionSearch").on("keyup", function() {
      const searchTerm = $(this).val().trim();
      loadActions(searchTerm);
    });

    $("#addActionBtn").on("click", function() {
      $("#actionForm")[0].reset();
      editingActionId = null;
      $("#actionForm button[type=submit]").text("Add Action");
      $("#actionForm").show();
      $("#actionTitle").focus();
    });

    function previewAction(action) {
      let html = `
        <div class="card-header">${action.title}
          <div class="btn-group float-right">
            <button class="btn btn-sm btn-warning action-btn" id="editActionBtn">Edit</button>
            <button class="btn btn-sm btn-danger action-btn" id="deleteActionBtn">Delete</button>
          </div>
        </div>
        <div class="card-body">
          <p>${action.description || "<em>No description</em>"}</p>
          
          <div class="row mb-3">
            <div class="col-md-4">
              <strong>AI Model:</strong><br>
              ${action.model || "gpt-3.5-turbo"}
            </div>
            <div class="col-md-4">
              <strong>Purpose:</strong><br>
              ${action.purpose || "generate"}
            </div>
            <div class="col-md-4">
              <strong>Web Search:</strong><br>
              ${action.enablewebsearch ? "Enabled" : "Disabled"}
            </div>
            <div class="col-md-4">
              <strong>Temperature:</strong><br>
              ${action.temperature || "0.7"}
            </div>
          </div>
          
          <div class="mb-3">
            <strong>Tags:</strong><br>
            ${action.tags && action.tags.length ? 
              action.tags.map(t => `<span class="badge badge-info mr-1">${t}</span>`).join("") : 
              "<em>No tags</em>"}
          </div>
          
          <div>
            <strong>Prompt Template:</strong>
            <pre class="bg-light p-2 border rounded">${action.prompt}</pre>
          </div>
        </div>
      `;
      
      $("#actionPreview").html(html);
      $("#runActionBtn").prop("disabled", false);
      $("#runActionBtn").data("action-id", action.id);
      //edit and delete buttons
      $("#editActionBtn").off("click").on("click", function(e) {
        e.stopPropagation();
        editAction(action);
      });

      $("#deleteActionBtn").off("click").on("click", function(e) {
        e.stopPropagation();
        deleteAction(action.id);
      });
    }

    function editAction(action) {
      editingActionId = action.id;
      $("#actionTitle").val(action.title);
      $("#actionDescription").val(action.description || "");
      $("#actionTags").val(action.tags ? action.tags.join(", ") : "");
      $("#actionModel").val(action.model || "gpt-3.5-turbo");
      $("#actionPurpose").val(action.purpose || "generate");
      $("#actionTemperature").val(action.temperature || "0.7");
      $("#tempValue").text(action.temperature || "0.7");
      $("#enableWebSearch").prop("checked", action.enablewebsearch || false);

      $("#useTools").prop("checked", action.useTools || false).trigger("change");
      $("#toolsDefinition").val(action.toolsDefinition || "");

      $("#actionPrompt").val(action.prompt);
      $("#saveActionBtn").text("Update Action");
      // focus on the title field
      $("#actionForm").show();
      $("#actionTitle").focus();
    }

    function deleteAction(id) {
      if (confirm("Are you sure you want to delete this action?")) {
        const transaction = db.transaction("actions", "readwrite");
        const store = transaction.objectStore("actions");
        store.delete(id).onsuccess = function() {
          loadActions();
          showNotification("Action deleted successfully!");
          if (editingActionId === id) {
            resetActionForm();
          }
        };
      }
    }

    function resetActionForm() {
      editingActionId = null;
      $("#actionForm")[0].reset();
      $("#tempValue").text("0.7");
      $("#saveActionBtn").text("Save Action");
      $("#actionPreview").html('<p class="text-muted">Select an action to preview its settings and prompt template.</p>');
      $("#runActionBtn").prop("disabled", true);
    }

    $("#cancelActionBtn").on("click", function(e) {
      e.preventDefault();
      resetActionForm();
    });

    $("#actionForm").on("submit", function(e) {
      e.preventDefault();
      
      const title = $("#actionTitle").val().trim();
      const description = $("#actionDescription").val().trim();
      const tags = $("#actionTags").val().split(",").map(s => s.trim()).filter(s => s);
      const model = $("#actionModel").val();
      const purpose = $("#actionPurpose").val();
      const enablewebsearch = $("#enableWebSearch").is(":checked") ? true : false;
      const useTools = $("#useTools").is(":checked") ? true : false;
      const toolsDefinition = $("#toolsDefinition").val().trim();
      const temperature = $("#actionTemperature").val();
      const prompt = $("#actionPrompt").val().trim();
      
      const transaction = db.transaction("actions", "readwrite");
      const store = transaction.objectStore("actions");
      
      if (editingActionId) {
        store.get(editingActionId).onsuccess = function(e) {
          let action = e.target.result;
          action.title = title;
          action.description = description;
          action.tags = tags;
          action.model = model;
          action.purpose = purpose;
          action.temperature = temperature;
          action.enablewebsearch = enablewebsearch;
          action.useTools = useTools;
          action.toolsDefinition = toolsDefinition;
          action.prompt = prompt;
          action.updated = new Date();
          
          store.put(action).onsuccess = function() {
            showNotification("Action updated successfully!");
            resetActionForm();
            loadActions();
          };
        };
      } else {
        const action = {
          title,
          description,
          tags,
          model,
          purpose,
          temperature,
          enablewebsearch,
          useTools,
          toolsDefinition,
          prompt,
          created: new Date()
        };
        
        store.add(action).onsuccess = function() {
          showNotification("New action created!");
          resetActionForm();
          loadActions();
        };
      }
    });

    $("#runActionBtn").on("click", function() {
      const actionId = $(this).data("action-id");
      selectedActionId = actionId;
      
      const transaction = db.transaction("actions", "readonly");
      const store = transaction.objectStore("actions");
      
      store.get(parseInt(actionId)).onsuccess = function(e) {
        const action = e.target.result;
        if (!action) {
          showNotification("Action not found", "danger");
          return;
        }
        
        selectedContentItems = [];
        updateSelectedItemsUI();
        
        let selectionInfo = "";
        let selectionMode = "multiple";
        
        switch(action.purpose) {
          case "modify":
            selectionInfo = "Select zero or one block/paragraph to modify.";
            selectionMode = "single";
            break;
          case "generate":
            selectionInfo = "Select zero or multiple blocks/paragraphs as reference for generation.";
            selectionMode = "multiple";
            break;
          case "analyze":
          case "synthesize":
            selectionInfo = "Select one or multiple blocks/paragraphs to " + action.purpose + ".";
            selectionMode = "multiple-required";
            break;
          default:
            selectionInfo = "Select content to process with this action.";
        }
        
        $(".action-selection-info").text(selectionInfo);
        $("#contentSelectionModal").data("selection-mode", selectionMode);
        
        loadBlocksForSelection();
        loadDocumentsForSelection();
        
        $("#contentSelectionModal").modal("show");
      };
    });

    function loadBlocksForSelection(searchTerm = "") {
      const blocksList = $(".block-selection-list");
      blocksList.html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading blocks...</div>');
      
      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      let blocksHtml = '';
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const block = cursor.value;
          const searchableText = (
            (block.title || "") + " " + 
            block.text + " " + 
            (block.tags ? block.tags.join(" ") : "") + " " + 
            (block.reference || "")
          ).toLowerCase();
          
          if (!searchTerm || searchableText.indexOf(searchTerm.toLowerCase()) !== -1) {
            const title = block.title || "Block " + block.id;
            const preview = block.text.length > 100 ? block.text.substring(0, 100) + "..." : block.text;
            
            blocksHtml += `
              <div class="card mb-2 selectable-block" data-id="${block.id}" data-type="block" data-title="${title}">
                <div class="card-body py-2">
                  <div class="form-check">
                    <input class="form-check-input select-content-item" type="checkbox" id="block-${block.id}">
                    <label class="form-check-label w-100" for="block-${block.id}">
                      <strong>${title}</strong> <small class="text-muted">(ID: ${block.id})</small><br>
                      <small>${preview}</small>
                      ${block.tags && block.tags.length ? 
                        `<div class="mt-1">${block.tags.map(t => `<span class="badge badge-info">${t}</span>`).join(' ')}</div>` : ''}
                    </label>
                  </div>
                </div>
              </div>
            `;
          }
          cursor.continue();
        } else {
          if (blocksHtml) {
            blocksList.html(blocksHtml);
            
            $(".selectable-block .select-content-item").on("change", function() {
              const block = $(this).closest(".selectable-block");
              const blockId = block.data("id");
              const blockTitle = block.data("title");
              const selectionMode = $("#contentSelectionModal").data("selection-mode");
              
              if ($(this).prop("checked")) {
                if (selectionMode === "single" && selectedContentItems.length > 0) {
                  $(".select-content-item").not(this).prop("checked", false);
                  selectedContentItems = [];
                }
                
                selectedContentItems.push({
                  id: blockId,
                  type: "block",
                  title: blockTitle
                });
              } else {
                selectedContentItems = selectedContentItems.filter(item => 
                  !(item.type === "block" && item.id === blockId)
                );
              }
              
              updateSelectedItemsUI();
            });
            
          } else {
            blocksList.html('<p class="text-center text-muted">No blocks found matching your search.</p>');
          }
        }
      };
    }

    function loadDocumentsForSelection(searchTerm = "") {
      const docsList = $(".document-selection-list");
      docsList.html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading documents...</div>');
      
      const transaction = db.transaction("documents", "readonly");
      const store = transaction.objectStore("documents");
      let docsHtml = '';
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const doc = cursor.value;
          const searchableText = doc.title.toLowerCase();
          
          if (!searchTerm || searchableText.indexOf(searchTerm.toLowerCase()) !== -1) {
            docsHtml += `
              <div class="card mb-2 selectable-document" data-id="${doc.id}" data-title="${doc.title}">
                <div class="card-body py-2">
                  <strong>${doc.title}</strong> <small class="text-muted">(ID: ${doc.id})</small>
                  <button class="btn btn-sm btn-outline-primary float-right load-paragraphs-btn">
                    Show Paragraphs
                  </button>
                </div>
              </div>
            `;
          }
          cursor.continue();
        } else {
          if (docsHtml) {
            docsList.html(docsHtml);
            
            $(".load-paragraphs-btn").on("click", function() {
              const docId = $(this).closest(".selectable-document").data("id");
              loadParagraphsForSelection(docId);
            });
            
          } else {
            docsList.html('<p class="text-center text-muted">No documents found matching your search.</p>');
          }
        }
      };
    }

    function loadParagraphsForSelection(docId) {
      const paragraphsList = $(".paragraph-selection-list");
      paragraphsList.html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading paragraphs...</div>');
      
      const transaction = db.transaction("documents", "readonly");
      const store = transaction.objectStore("documents");
      
      store.get(parseInt(docId)).onsuccess = function(e) {
        const doc = e.target.result;
        if (doc && doc.paragraphs) {
          let paragraphsHtml = '';
          
          doc.paragraphs.forEach((para, index) => {
            const preview = para.content.length > 100 ? para.content.substring(0, 100) + "..." : para.content;
            
            paragraphsHtml += `
              <div class="card mb-2 selectable-paragraph" data-id="${doc.id}-${index}" data-doc-id="${doc.id}" 
                   data-para-index="${index}" data-doc-title="${doc.title}" data-type="paragraph">
                <div class="card-body py-2">
                  <div class="form-check">
                    <input class="form-check-input select-content-item" type="checkbox" id="para-${doc.id}-${index}">
                    <label class="form-check-label w-100" for="para-${doc.id}-${index}">
                      <strong>Paragraph ${index + 1}</strong> <small class="text-muted">(Document: ${doc.title})</small><br>
                      <small>${preview}</small>
                      ${para.tags && para.tags.length ? 
                        `<div class="mt-1">${para.tags.map(t => `<span class="badge badge-info">${t}</span>`).join(' ')}</div>` : ''}
                    </label>
                  </div>
                </div>
              </div>
            `;
          });
          
          paragraphsList.html(paragraphsHtml);
          
          $(".selectable-paragraph .select-content-item").on("change", function() {
            const paragraph = $(this).closest(".selectable-paragraph");
            const docId = paragraph.data("doc-id");
            const paraIndex = paragraph.data("para-index");
            const docTitle = paragraph.data("doc-title");
            const itemId = `${docId}-${paraIndex}`;
            const selectionMode = $("#contentSelectionModal").data("selection-mode");
            
            if ($(this).prop("checked")) {
              if (selectionMode === "single" && selectedContentItems.length > 0) {
                $(".select-content-item").not(this).prop("checked", false);
                selectedContentItems = [];
              }
              
              selectedContentItems.push({
                id: itemId,
                docId: docId,
                paraIndex: paraIndex,
                type: "paragraph",
                title: `Paragraph ${paraIndex + 1} from ${docTitle}`
              });
            } else {
              selectedContentItems = selectedContentItems.filter(item => 
                !(item.type === "paragraph" && item.id === itemId)
              );
            }
            
            updateSelectedItemsUI();
          });
        } else {
          paragraphsList.html('<p class="text-center text-muted">No paragraphs found in this document.</p>');
        }
      };
    }

    function updateSelectedItemsUI() {
      const selectedItemsList = $("#selectedItemsList");
      const selectedItemsCount = $("#selectedItemsCount");
      
      selectedItemsCount.text(selectedContentItems.length);
      
      if (selectedContentItems.length === 0) {
        selectedItemsList.html('<p class="text-muted text-center mb-0">No items selected</p>');
      } else {
        let itemsHtml = '';
        
        selectedContentItems.forEach((item, index) => {
          itemsHtml += `
            <div class="selected-item mb-1 d-flex justify-content-between align-items-center">
              <span>${item.title} <small class="text-muted">(${item.type})</small></span>
              <button type="button" class="btn btn-sm btn-outline-danger remove-selected-item" data-index="${index}">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
        });
        
        selectedItemsList.html(itemsHtml);
        
        $(".remove-selected-item").on("click", function() {
          const index = $(this).data("index");
          const itemToRemove = selectedContentItems[index];
          
          if (itemToRemove.type === "block") {
            $(`#block-${itemToRemove.id}`).prop("checked", false);
          } else if (itemToRemove.type === "paragraph") {
            $(`#para-${itemToRemove.id}`).prop("checked", false);
          }
          
          selectedContentItems.splice(index, 1);
          updateSelectedItemsUI();
        });
      }
    }

    $("#searchBlocksSelectionBtn").on("click", function() {
      const searchTerm = $("#blockSelectionSearch").val().trim();
      loadBlocksForSelection(searchTerm);
    });
    
    $("#searchDocsSelectionBtn").on("click", function() {
      const searchTerm = $("#docSelectionSearch").val().trim();
      loadDocumentsForSelection(searchTerm);
    });
    
    $("#blockSelectionSearch").keypress(function(e) {
      if (e.which === 13) {
        $("#searchBlocksSelectionBtn").click();
      }
    });
    
    $("#docSelectionSearch").keypress(function(e) {
      if (e.which === 13) {
        $("#searchDocsSelectionBtn").click();
      }
    });

    $("#confirmContentSelection").on("click", async function() {
      const selectionMode = $("#contentSelectionModal").data("selection-mode");
      
      if (selectionMode === "multiple-required" && selectedContentItems.length === 0) {
        showNotification("Please select at least one item", "warning");
        return;
      }
      
      if (selectionMode === "single" && selectedContentItems.length > 1) {
        showNotification("Please select only one item", "warning");
        return;
      }
      
      $("#contentSelectionModal").modal("hide");
      
      $("#actionResultContainer").html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Processing your request...</div>');
      
      try {
        const contentText = await assembleContentFromSelectedItems();
        runActionWithContent(selectedActionId, contentText);
      } catch (error) {
        $("#actionResultContainer").html(`
          <div class="alert alert-danger">
            <strong>Error:</strong> ${error.message || error}
          </div>
        `);
      }
    });

    async function assembleContentFromSelectedItems() {
      let contentParts = [];
      const blockFetchPromises = [];
      const paragraphFetchPromises = [];
      
      for (const item of selectedContentItems) {
        if (item.type === "block") {
          blockFetchPromises.push(
            new Promise((resolve, reject) => {
              const transaction = db.transaction("blocks", "readonly");
              const store = transaction.objectStore("blocks");
              
              store.get(parseInt(item.id)).onsuccess = function(e) {
                const block = e.target.result;
                if (block) {
                  const blockText = `## ${block.title || 'Block ' + block.id}\n${block.text}`;
                  resolve({
                    id: block.id,
                    text: blockText,
                    originalBlock: block
                  });
                } else {
                  reject(new Error(`Block with ID ${item.id} not found`));
                }
              };
            })
          );
        } else if (item.type === "paragraph") {
          paragraphFetchPromises.push(
            new Promise((resolve, reject) => {
              const transaction = db.transaction("documents", "readonly");
              const store = transaction.objectStore("documents");
              
              store.get(parseInt(item.docId)).onsuccess = function(e) {
                const doc = e.target.result;
                if (doc && doc.paragraphs && doc.paragraphs[item.paraIndex]) {
                  const para = doc.paragraphs[item.paraIndex];
                  const paraText = `## Paragraph ${parseInt(item.paraIndex) + 1} from ${doc.title}\n${para.content}`;
                  
                  const blockRefs = para.blockRefs || (para.blockRef ? [para.blockRef] : []);
                  const refBlockPromises = blockRefs.map(blockId => 
                    new Promise((resolveBlock) => {
                      const blockTx = db.transaction("blocks", "readonly");
                      const blockStore = blockTx.objectStore("blocks");
                      
                      blockStore.get(parseInt(blockId)).onsuccess = function(ev) {
                        const refBlock = ev.target.result;
                        if (refBlock) {
                          resolveBlock({
                            id: refBlock.id,
                            text: `### Referenced Block: ${refBlock.title || 'Block ' + refBlock.id}\n${refBlock.text}`,
                            originalBlock: refBlock
                          });
                        } else {
                          resolveBlock(null);
                        }
                      };
                    })
                  );
                  
                  Promise.all(refBlockPromises).then(refBlocks => {
                    const filteredRefBlocks = refBlocks.filter(b => b !== null);
                    resolve({
                      id: item.id,
                      text: paraText,
                      refBlocks: filteredRefBlocks
                    });
                  });
                } else {
                  reject(new Error(`Paragraph not found in document ${item.docId}`));
                }
              };
            })
          );
        }
      }
      
      const blocks = await Promise.all(blockFetchPromises);
      for (const block of blocks) {
        contentParts.push(block.text);
      }
      
      const paragraphs = await Promise.all(paragraphFetchPromises);
      for (const para of paragraphs) {
        contentParts.push(para.text);
        
        if (para.refBlocks && para.refBlocks.length) {
          for (const refBlock of para.refBlocks) {
            contentParts.push(refBlock.text);
          }
        }
      }
      
      const inputContent = $("#actionTestInput").val().trim();
      if (inputContent) {
        contentParts.push(inputContent);
      }
      
      return contentParts.join("\n\n---\n\n");
    }

    function runActionWithContent(actionId, content) {
      const transaction = db.transaction("actions", "readonly");
      const store = transaction.objectStore("actions");
      
      store.get(parseInt(actionId)).onsuccess = function(e) {
        const action = e.target.result;
        if (!action) {
          $("#actionResultContainer").html('<div class="alert alert-danger">Action not found</div>');
          return;
        }
        
        const contentPreview = $(`
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Content Preview</span>
              <button class="btn btn-sm btn-outline-secondary toggle-content-btn">
                <i class="fas fa-eye-slash"></i> Hide
              </button>
            </div>
            <div class="card-body content-preview-body">
              <div class="alert alert-info">
                <small class="text-muted">This is the content that will be processed:</small>
              </div>
                <pre class="bg-light p-2 border rounded" id="combinedContent">${content || '<em>No content provided</em>'}</pre>
            </div>
          </div>
        `);
        
        contentPreview.find('.toggle-content-btn').on('click', function() {
          const previewBody = contentPreview.find('.content-preview-body');
          const btn = $(this);
          
          if (previewBody.is(':visible')) {
            previewBody.slideUp();
            btn.html('<i class="fas fa-eye"></i> Show');
          } else {
            previewBody.slideDown();
            btn.html('<i class="fas fa-eye-slash"></i> Hide');
          }
        });
        
        const processedPrompt = action.prompt.replace(/{content}/g, content || "");
        
        if (!openaiApiKey) {
          $("#actionResultContainer").html(`
            <div class="alert alert-warning">
              <strong>API Key Missing!</strong> Please add your OpenAI API key in the Settings tab to use this feature.
            </div>
          `);
          return;
        }
        
        $("#actionResultContainer").html('');
        $("#actionResultContainer").append(contentPreview);
        $("#actionResultContainer").append('<div class="text-center my-3"><i class="fas fa-spinner fa-spin"></i> Processing your request...</div>');
        
        callOpenAiApi(action, processedPrompt).then(response => {
          $("#actionResultContainer").find('.text-center').remove();
          $("#actionResultContainer").append(`
            <div class="card">
              <div class="card-header">Result</div>
              <div class="card-body">
                <div class="bg-light p-3 border rounded result-content">${marked.parse(response)}</div>
                <div class="mt-3">
                  <button class="btn btn-sm btn-outline-primary copy-result-btn">
                    <i class="fas fa-copy"></i> Copy Results
                  </button>
                  <button class="btn btn-sm btn-outline-success save-as-paragraph-btn">
                    <i class="fas fa-save"></i> Save as Paragraph
                  </button>
                </div>
              </div>
            </div>
          `);
          
          $("#actionResultContainer").data("raw-result", response);
          
          $(".copy-result-btn").click(function() {
            copyTextToClipboard(response);
          });
          
          $(".save-as-paragraph-btn").click(function() {
            saveResultAsParagraph(response);
          });
        }).catch(error => {
          $("#actionResultContainer").find('.text-center').remove();
          $("#actionResultContainer").append(`
            <div class="alert alert-danger">
              <strong>Error:</strong> ${error.message || error}
            </div>
          `);
        });
      };
    }

    function copyTextToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.setAttribute('readonly', '');
      textarea.style.position = 'absolute';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      
      textarea.select();
      document.execCommand('copy');
      
      document.body.removeChild(textarea);
      
      showNotification("Results copied to clipboard!");
    }
    
    function saveResultAsParagraph(text) {
      $('#viewTabs a[href="#documentsView"]').tab('show');
      
      if ($("#paragraphContainer").children().length === 0) {
        addParagraph();
      } else {
        addParagraph();
      }
      
      const lastParagraph = $("#paragraphContainer .paragraph-block").last();
      lastParagraph.find(".docParagraph").val(text);
      
      showNotification("Results added as a new paragraph!", "success");
    }

    async function callOpenAiApi(action, prompt) {
      try {
        const payload = {
          model: action.model || "gpt-3.5-turbo",
          messages: [
            { role: "system", content: action.description || "You are a helpful assistant." },
            { role: "user", content: prompt }
          ],
          temperature: parseFloat(action.temperature) || 0.7,
          max_tokens: 800
        };
        
        if (action.enablewebsearch) {
          payload.web_search_options = {};
        }

        if (action.useTools && action.toolsDefinition) {
          try {
            const parsedTools = JSON.parse(action.toolsDefinition);
            payload.tools = Array.isArray(parsedTools) ? parsedTools : [parsedTools];
            console.log("Tools:", payload.tools);
          } catch (error) {
            throw new Error("Invalid tools definition JSON");
          }
        }

        if (action.enablewebsearch) {
          delete payload.temperature;
        }
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${openaiApiKey}`
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || 'API request failed');
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error("OpenAI API Error:", error);
        throw error;
      }
    }

    $("#useTools").on("change", function() {
      if ($(this).is(":checked")) {
        $("#toolsDefinitionContainer").slideDown();
      } else {
        $("#toolsDefinitionContainer").slideUp();
      }
    });

    /**********************
     * OpenAI API Settings - Checked
     **********************/
    
    $("#apiSettingsForm").on("submit", function(e) {
      e.preventDefault();
      const apiKey = $("#apiKey").val().trim();
      
      if (apiKey) {
        localStorage.setItem('openai_api_key', apiKey);
        openaiApiKey = apiKey;
        showNotification("API key saved successfully!");
        updateApiKeyStatus();
      } else {
        showNotification("Please enter an API key", "warning");
      }
    });
    
    $("#clearApiKey").on("click", function() {
      if (confirm("Are you sure you want to remove your API key?")) {
        localStorage.removeItem('openai_api_key');
        openaiApiKey = null;
        $("#apiKey").val('');
        showNotification("API key removed");
        updateApiKeyStatus();
      }
    });
    
    function updateApiKeyStatus() {
      const statusDiv = $("#apiKeyStatus");
      
      if (openaiApiKey) {
        statusDiv.html(`
          <div class="alert alert-success mb-0">
            API key is configured
          </div>
        `);
      } else {
        statusDiv.html(`
          <div class="alert alert-warning mb-0">
            No API key configured
          </div>
        `);
      }
    }

    /**********************
     * Import / Export
     **********************/
    $("#exportBtn").on("click", function() {
      const exportData = {};
      const tx = db.transaction(["documents", "blocks", "references", "actions", "collections"], "readonly");
      Promise.all([
        new Promise(resolve => {
          const docs = [];
          tx.objectStore("documents").openCursor().onsuccess = function(e) {
            const cursor = e.target.result;
            if(cursor){ docs.push(cursor.value); cursor.continue(); }
            else { resolve(docs); }
          };
        }),
        new Promise(resolve => {
          const blocks = [];
          tx.objectStore("blocks").openCursor().onsuccess = function(e) {
            const cursor = e.target.result;
            if(cursor){ blocks.push(cursor.value); cursor.continue(); }
            else { resolve(blocks); }
          };
        }),
        new Promise(resolve => {
          const references = [];
          tx.objectStore("references").openCursor().onsuccess = function(e) {
            const cursor = e.target.result;
            if(cursor){ references.push(cursor.value); cursor.continue(); }
            else { resolve(references); }
          };
        }),
        new Promise(resolve => {
          const actions = [];
          tx.objectStore("actions").openCursor().onsuccess = function(e) {
            const cursor = e.target.result;
            if(cursor){ actions.push(cursor.value); cursor.continue(); }
            else { resolve(actions); }
          };
        }),
        new Promise(resolve => {
          const collections = [];
          tx.objectStore("collections").openCursor().onsuccess = function(e) {
            const cursor = e.target.result;
            if(cursor){ collections.push(cursor.value); cursor.continue(); }
            else { resolve(collections); }
          };
        })
      ]).then(function(results) {
        exportData.documents = results[0];
        exportData.blocks = results[1];
        exportData.references = results[2];
        exportData.actions = results[3];
        exportData.collections = results[4];
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        const filename = `markdown-notes-export-${timestamp}.json`;
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = filename; a.click();
      });
    });

    $("#importFile").on("change", function(e) {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          importedData = JSON.parse(e.target.result);
          
          const totalItems = (importedData.documents?.length || 0) + 
                            ((importedData.blocks?.length || 0) + (importedData.clauses?.length || 0)) +
                            (importedData.references?.length || 0) +
                            (importedData.actions?.length || 0) +
                            (importedData.collections?.length || 0);
          
          $("#importItemCount").text(totalItems);
          
          $("#importOptionsModal").modal("show");
        } catch (error) {
          console.error("Error parsing JSON:", error);
          showNotification("Invalid JSON file. Import failed.", "danger");
        }
      };
      reader.readAsText(file);
    });

    $("#confirmImport").on("click", function() {
      if (!importedData) {
        $("#importOptionsModal").modal("hide");
        return;
      }
      
      const importOption = $('input[name="importOption"]:checked').val();
      processImport(importedData, importOption);
      
      $("#importFile").val("");
      importedData = null;
      $("#importOptionsModal").modal("hide");
    });

    function processImport(data, option) {
      const tx = db.transaction(["documents", "blocks", "references", "actions", "collections"], "readwrite");
      const docStore = tx.objectStore("documents");
      const blockStore = tx.objectStore("blocks");
      const referenceStore = tx.objectStore("references");
      const actionStore = tx.objectStore("actions");
      const collectionStore = tx.objectStore("collections");
      
      let successCount = 0;
      
      if (data.documents && data.documents.length > 0) {
        data.documents.forEach(doc => {
          if (option === "merge") {
            const request = docStore.get(doc.id);
            request.onsuccess = function(event) {
              if (!event.target.result) {
                docStore.put(doc);
                successCount++;
              }
            };
          } else {
            docStore.put(doc);
            successCount++;
          }
        });
      }
      
      const processBlocks = (blocks) => {
        if (!blocks || blocks.length === 0) return;
        
        blocks.forEach(block => {
          if (!block.title) {
            block.title = "Block " + (block.id || "");
          }
          
          if (option === "merge") {
            const request = blockStore.get(block.id);
            request.onsuccess = function(event) {
              if (!event.target.result) {
                blockStore.put(block);
                successCount++;
              }
            };
          } else {
            blockStore.put(block);
            successCount++;
          }
        });
      };
      
      processBlocks(data.blocks);
      
      processBlocks(data.clauses);
      
      if (data.references && data.references.length > 0) {
        data.references.forEach(ref => {
          if (option === "merge") {
            const request = referenceStore.get(ref.id);
            request.onsuccess = function(event) {
              if (!event.target.result) {
                referenceStore.put(ref);
                successCount++;
              }
            };
          } else {
            referenceStore.put(ref);
            successCount++;
          }
        });
      }
      
      if (data.actions && data.actions.length > 0) {
        data.actions.forEach(action => {
          if (option === "merge") {
            const request = actionStore.get(action.id);
            request.onsuccess = function(event) {
              if (!event.target.result) {
                actionStore.put(action);
                successCount++;
              }
            };
          } else {
            actionStore.put(action);
            successCount++;
          }
        });
      }

      if (data.collections && data.collections.length > 0) {
        data.collections.forEach(collection => {
          if (option === "merge") {
            const request = collectionStore.get(collection.id);
            request.onsuccess = function(event) {
              if (!event.target.result) {
                collectionStore.put(collection);
                successCount++;
              }
            };
          } else {
            collectionStore.put(collection);
            successCount++;
          }
        });
      }
      
      tx.oncomplete = function() {
        const actionText = option === "merge" ? "merged" : "imported";
        showNotification(`Import completed successfully! Data was ${actionText}.`);
        loadDocuments();
        loadBlocks();
        loadReferencesMetadata();
        loadActions();
        loadCollections();
        updateBlockAutocomplete();
        updateReferenceAutocomplete();
        updateTagAutocomplete();
      };
      
      tx.onerror = function(event) {
        console.error("Import transaction error:", event.target.error);
        showNotification("Error during import: " + event.target.error.message, "danger");
      };
    }

    $(document).ready(function() {
      const resetDbBtn = $(`
        <div class="card mt-3">
          <div class="card-header bg-danger text-white">Database Troubleshooting</div>
          <div class="card-body">
            <div class="alert alert-warning">
              <strong>Warning:</strong> Only use this option if you're experiencing database errors or if instructed by support.
              This will delete all your data and cannot be undone!
            </div>
            <button id="resetDbBtn" class="btn btn-danger">Reset Database</button>
            <div class="mt-3">
              <small class="text-muted">Use this option to delete the current database if you're experiencing persistent errors, especially after updating the application.</small>
            </div>
          </div>
        </div>
      `);
      
      $("#settingsView .editor-col").append(resetDbBtn);
      
      $("#resetDbBtn").on("click", function() {
        const confirmReset = confirm("WARNING: This will permanently delete all your data including blocks, references, and documents. This action cannot be undone. Are you sure you want to proceed?");
        
        if (confirmReset) {
          if (db) {
            db.close();
          }
          
          const deleteRequest = indexedDB.deleteDatabase("EnhancedNoteDB");
          
          deleteRequest.onsuccess = function() {
            alert("Database successfully deleted. Please refresh the page to create a new database.");
            $(".container").prepend(`
              <div class="alert alert-success">
                <strong>Success!</strong> Database has been reset. 
                <a href="javascript:location.reload()" class="alert-link">Click here to refresh the page</a> or refresh manually to complete the process.
              </div>
            `);
          };
          
          deleteRequest.onerror = function(event) {
            console.error("Database deletion failed:", event.target.error);
            alert("Error deleting database: " + event.target.error);
          };
          
          deleteRequest.onblocked = function() {
            alert("Database deletion was blocked. Please close all other tabs with this application and try again.");
          }
        }
      });
    });

    function loadTagsForSelection(searchTerm = "") {
      const tagsCloud = $(".tag-selection-cloud");
      tagsCloud.html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading tags...</div>');
      
      const tagCounts = {};
      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const block = cursor.value;
          if (block.tags && block.tags.length) {
            block.tags.forEach(tag => {
              if (!searchTerm || tag.toLowerCase().includes(searchTerm.toLowerCase())) {
                if (tagCounts[tag]) {
                  tagCounts[tag]++;
                } else {
                  tagCounts[tag] = 1;
                }
              }
            });
          }
          cursor.continue();
        } else {
          if (Object.keys(tagCounts).length === 0) {
            tagsCloud.html('<p class="text-center text-muted">No tags found matching your search.</p>');
            return;
          }
          
          const sortedTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
          let tagsHtml = '';
          
          sortedTags.forEach(tag => {
            const count = tagCounts[tag];
            tagsHtml += `
              <button class="btn btn-sm btn-outline-info m-1 selectable-tag" data-tag="${tag}">
                ${tag} <span class="badge badge-light">${count}</span>
              </button>
            `;
          });
          
          tagsCloud.html(tagsHtml);
          
          $(".selectable-tag").click(function() {
            const tag = $(this).data("tag");
            $(".selectable-tag").removeClass("active");
            $(this).addClass("active");
            loadContentByTagForSelection(tag);
          });
        }
      };
    }
    
    function loadContentByTagForSelection(tag) {
      const taggedItemsList = $(".tagged-items-list");
      taggedItemsList.html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading content...</div>');
      
      const taggedBlocks = [];
      const taggedParagraphs = [];
      let blocksLoaded = false;
      let paragraphsLoaded = false;
      
      function renderResults() {
        if (!blocksLoaded || !paragraphsLoaded) return;
        
        if (taggedBlocks.length === 0 && taggedParagraphs.length === 0) {
          taggedItemsList.html('<p class="text-center text-muted">No content found with this tag.</p>');
          return;
        }
        
        let resultsHtml = '';
        
        if (taggedBlocks.length > 0) {
          resultsHtml += '<h6 class="mt-2">Blocks:</h6>';
          taggedBlocks.forEach(block => {
            const preview = block.text.length > 100 ? block.text.substring(0, 100) + "..." : block.text;
            resultsHtml += `
              <div class="card mb-2 selectable-tag-item" data-id="${block.id}" data-type="block" data-title="${block.title || 'Block ' + block.id}">
                <div class="card-body py-2">
                  <div class="form-check">
                    <input class="form-check-input select-content-item" type="checkbox" id="tag-block-${block.id}">
                    <label class="form-check-label w-100" for="tag-block-${block.id}">
                      <strong>${block.title || 'Block ' + block.id}</strong> <small class="text-muted">(ID: ${block.id})</small><br>
                      <small>${preview}</small>
                    </label>
                  </div>
                </div>
              </div>
            `;
          });
        }
        
        if (taggedParagraphs.length > 0) {
          resultsHtml += '<h6 class="mt-3">Paragraphs:</h6>';
          taggedParagraphs.forEach(para => {
            const preview = para.content.length > 100 ? para.content.substring(0, 100) + "..." : para.content;
            resultsHtml += `
              <div class="card mb-2 selectable-tag-item" data-id="${para.docId}-${para.index}" data-doc-id="${para.docId}" 
                   data-para-index="${para.index}" data-type="paragraph" data-title="Paragraph ${para.index + 1} from ${para.docTitle}">
                <div class="card-body py-2">
                  <div class="form-check">
                    <input class="form-check-input select-content-item" type="checkbox" id="tag-para-${para.docId}-${para.index}">
                    <label class="form-check-label w-100" for="tag-para-${para.docId}-${para.index}">
                      <strong>Paragraph ${para.index + 1}</strong> <small class="text-muted">(Document: ${para.docTitle})</small><br>
                      <small>${preview}</small>
                    </label>
                  </div>
                </div>
              </div>
            `;
          });
        }
        
        taggedItemsList.html(resultsHtml);
        
        $(".selectable-tag-item .select-content-item").change(function() {
          const item = $(this).closest(".selectable-tag-item");
          const itemType = item.data("type");
          const itemId = item.data("id");
          const itemTitle = item.data("title");
          const selectionMode = $("#contentSelectionModal").data("selection-mode");
          
          if ($(this).prop("checked")) {
            if (selectionMode === "single" && selectedContentItems.length > 0) {
              $(".select-content-item").not(this).prop("checked", false);
              selectedContentItems = [];
            }
            
            if (itemType === "block") {
              selectedContentItems.push({
                id: parseInt(itemId),
                type: "block",
                title: itemTitle
              });
            } else if (itemType === "paragraph") {
              const docId = item.data("doc-id");
              const paraIndex = item.data("para-index");
              selectedContentItems.push({
                id: itemId,
                docId: parseInt(docId),
                paraIndex: parseInt(paraIndex),
                type: "paragraph",
                title: itemTitle
              });
            }
          } else {
            selectedContentItems = selectedContentItems.filter(selected => 
              !(selected.type === itemType && selected.id.toString() === itemId.toString())
            );
          }
          
          updateSelectedItemsUI();
        });
      }
      
      const blockTx = db.transaction("blocks", "readonly");
      const blockStore = blockTx.objectStore("blocks");
      
      blockStore.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const block = cursor.value;
          if (block.tags && block.tags.includes(tag)) {
            taggedBlocks.push(block);
          }
          cursor.continue();
        } else {
          blocksLoaded = true;
          renderResults();
        }
      };
      
      const docTx = db.transaction("documents", "readonly");
      const docStore = docTx.objectStore("documents");
      
      docStore.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const doc = cursor.value;
          if (doc.paragraphs) {
            doc.paragraphs.forEach((para, index) => {
              if (para.tags && para.tags.includes(tag)) {
                taggedParagraphs.push({
                  docId: doc.id,
                  index: index,
                  content: para.content,
                  docTitle: doc.title
                });
              }
            });
          }
          cursor.continue();
        } else {
          paragraphsLoaded = true;
          renderResults();
        }
      };
    }

    function loadReferencesForSelection(searchTerm = "") {
      const referencesList = $(".reference-selection-list");
      referencesList.html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading references...</div>');
      
      const transaction = db.transaction("references", "readonly");
      const store = transaction.objectStore("references");
      let referencesHtml = '';
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const reference = cursor.value;
          const searchableText = (reference.id + " " + reference.name + " " + (reference.description || "")).toLowerCase();
          
          if (!searchTerm || searchableText.indexOf(searchTerm.toLowerCase()) !== -1) {
            referencesHtml += `
              <div class="card mb-2 selectable-reference" data-id="${reference.id}" data-name="${reference.name}">
                <div class="card-body py-2">
                  <strong>${reference.id}</strong> - ${reference.name}
                  ${reference.type ? `<span class="badge badge-secondary ml-1">${reference.type}</span>` : ''}
                </div>
              </div>
            `;
          }
          cursor.continue();
        } else {
          if (referencesHtml) {
            referencesList.html(referencesHtml);
            
            $(".selectable-reference").click(function() {
              $(".selectable-reference").removeClass("active");
              $(this).addClass("active");
              
              const referenceId = $(this).data("id");
              loadBlocksForReference(referenceId);
            });
          } else {
            referencesList.html('<p class="text-center text-muted">No references found matching your search.</p>');
          }
        }
      };
    }
    
    function loadBlocksForReference(referenceId) {
      const blocksList = $(".reference-blocks-list");
      blocksList.html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading blocks...</div>');
      
      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      const blocksForReference = [];
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const block = cursor.value;
          if (block.reference === referenceId) {
            blocksForReference.push(block);
          }
          cursor.continue();
        } else {
          blocksForReference.sort((a, b) => {
            let al = a.refLevels || [];
            let bl = b.refLevels || [];
            for(let i = 0; i < Math.max(al.length, bl.length); i++){
              let av = al[i] || 0;
              let bv = bl[i] || 0;
              if(av !== bv) return av - bv;
            }
            return 0;
          });
          
          if (blocksForReference.length > 0) {
            let blocksHtml = '';
            
            blocksForReference.forEach(block => {
              const levelStr = block.refLevels && block.refLevels.length > 0 ? 
                block.refLevels.join(".") + " - " : '';
              const preview = block.text.length > 100 ? block.text.substring(0, 100) + "..." : block.text;
              
              blocksHtml += `
                <div class="card mb-2 selectable-ref-block" data-id="${block.id}" data-type="block" data-title="${block.title || 'Block ' + block.id}">
                  <div class="card-body py-2">
                    <div class="form-check">
                      <input class="form-check-input select-content-item" type="checkbox" id="ref-block-${block.id}">
                      <label class="form-check-label w-100" for="ref-block-${block.id}">
                        <strong>${levelStr}${block.title || 'Block ' + block.id}</strong> <small class="text-muted">(ID: ${block.id})</small><br>
                        <small>${preview}</small>
                      </label>
                    </div>
                  </div>
                </div>
              `;
            });
            
            blocksList.html(blocksHtml);
            
            $(".selectable-ref-block .select-content-item").change(function() {
              const block = $(this).closest(".selectable-ref-block");
              const blockId = parseInt(block.data("id"));
              const blockTitle = block.data("title");
              const selectionMode = $("#contentSelectionModal").data("selection-mode");
              
              if ($(this).prop("checked")) {
                if (selectionMode === "single" && selectedContentItems.length > 0) {
                  $(".select-content-item").not(this).prop("checked", false);
                  selectedContentItems = [];
                }
                
                selectedContentItems.push({
                  id: blockId,
                  type: "block",
                  title: blockTitle
                });
              } else {
                selectedContentItems = selectedContentItems.filter(item => 
                  !(item.type === "block" && item.id === blockId)
                );
              }
              
              updateSelectedItemsUI();
            });
          } else {
            blocksList.html('<p class="text-center text-muted">No blocks found for this reference.</p>');
          }
        }
      };
    }

    $("#searchTagsSelectionBtn").on("click", function() {
      const searchTerm = $("#tagSelectionSearch").val().trim();
      loadTagsForSelection(searchTerm);
    });
    
    $("#searchReferencesSelectionBtn").on("click", function() {
      const searchTerm = $("#referenceSelectionSearch").val().trim();
      loadReferencesForSelection(searchTerm);
    });

    $("#tagSelectionSearch").keypress(function(e) {
      if (e.which === 13) {
        $("#searchTagsSelectionBtn").click();
      }
    });
    
    $("#referenceSelectionSearch").keypress(function(e) {
      if (e.which === 13) {
        $("#searchReferencesSelectionBtn").click();
      }
    });

    $('#contentSelectionModal').on('shown.bs.modal', function() {
      loadBlocksForSelection();
      loadDocumentsForSelection();
      loadTagsForSelection();
      loadReferencesForSelection();
      
      selectedContentItems = [];
      updateSelectedItemsUI();
    });

    /**********************
     * Workflow Management
     **********************/
    let editingWorkflowId = null;

    function loadWorkflows(searchTerm = "") {
      $("#workflowList").empty();
      
      if (!db || db.version === null) {
        $("#workflowList").append('<li class="list-group-item text-danger">Database not available. Please refresh the page.</li>');
        return;
      }
      
      try {
        const transaction = db.transaction("workflows", "readonly");
        const store = transaction.objectStore("workflows");
        
        store.openCursor().onsuccess = function(e) {
          const cursor = e.target.result;
          if (cursor) {
            const workflow = cursor.value;
            const searchableText = (workflow.name + " " + (workflow.description || "")).toLowerCase();
            
            if (!searchTerm || searchableText.indexOf(searchTerm.toLowerCase()) !== -1) {
              const li = $("<li>")
                .addClass("list-group-item list-item")
                .html(`<strong>${workflow.name}</strong><br><small>${workflow.description || ""}</small>`)
                .click(function() { previewWorkflow(workflow); });
                
              const editBtn = $("<button>")
                .addClass("btn btn-sm btn-warning action-btn")
                .text("Edit")
                .click(function(e) { 
                  e.stopPropagation(); 
                  editWorkflow(workflow); 
                });
                
              const delBtn = $("<button>")
                .addClass("btn btn-sm btn-danger action-btn")
                .text("Delete")
                .click(function(e) { 
                  e.stopPropagation(); 
                  deleteWorkflow(workflow.id); 
                });
                
              li.append(editBtn, delBtn);
              $("#workflowList").append(li);
            }
            cursor.continue();
          }
        };
      } catch (err) {
        console.error("Error loading workflows:", err);
        $("#workflowList").append('<li class="list-group-item text-danger">Error loading workflows. Please refresh the page.</li>');
      }
    }

    function previewWorkflow(workflow) {
      let html = `
        <h5>Configure & Execute: test</h5>
        <p>${workflow.description || "<em>No description</em>"}</p>

         <div class="workflow-execution-container">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Configure inputs for each step and execute them in sequence. You can save this configuration for future runs.
          </div>
          <div id="workflow-steps-container"></div>
          <div id="workflow-final-actions" class="text-center mt-3 p-3 border-top d-none">
            <h5>Workflow Complete</h5>
            <div class="btn-group">
              <button class="btn btn-outline-primary copy-workflow-result-btn">
                <i class="fas fa-copy"></i> Copy Final Result
              </button>
              <button class="btn btn-outline-success save-workflow-result-btn">
                <i class="fas fa-save"></i> Save as Paragraph
              </button>
            </div>
          </div>
        </div>
        
        <div class="mt-3 btn-group">
          <button class="btn btn-primary run-workflow-interactive-btn" data-workflow-id="${workflow.id}">
            <i class="fas fa-cogs"></i> Configure & Run Step-by-Step
          </button>
          <button class="btn btn-success run-workflow-straight-btn" data-workflow-id="${workflow.id}">
            <i class="fas fa-play"></i> Run Entire Workflow
          </button>
        </div>
      `;
      
      $("#workflowPreview").html(html);
      $("#runWorkflowBtn").prop("disabled", false);
      $("#runWorkflowBtn").data("workflow-id", workflow.id);
    }

    $(document).on('click', '.run-workflow-interactive-btn', function() {
      const workflowId = $(this).data('workflow-id');
      runWorkflow(workflowId, 'interactive');
    });

    $(document).on('click', '.run-workflow-straight-btn', function() {
      const workflowId = $(this).data('workflow-id');
      runWorkflow(workflowId, 'straight');
    });

    function runWorkflow(workflowId, mode) {
      const transaction = db.transaction("workflows", "readonly");
      const store = transaction.objectStore("workflows");
      
      if (!workflowId) {
        showNotification("Invalid workflow ID", "danger");
        return;
      }
      
      try {
        const id = Number(workflowId);
        if (isNaN(id)) {
          throw new Error("Workflow ID must be a number");
        }
        
        store.get(id).onsuccess = function(e) {
          const workflow = e.target.result;
          if (!workflow) {
            showNotification("Workflow not found", "danger");
            return;
          }
          
          if (!workflow.steps || workflow.steps.length === 0) {
            showNotification("This workflow has no steps to run", "warning");
            return;
          }
          
          if (!workflow.configuredInputs) {
            workflow.configuredInputs = workflow.steps.map(() => ({ 
              custom: { enabled: true, content: '' },
              previous: { enabled: false },
              selected: { enabled: false, items: [] }
            }));
          } else {
            workflow.configuredInputs = workflow.configuredInputs.map(input => {
              if (input.type) {
                const newFormat = {
                  custom: { enabled: input.type === 'custom', content: input.content || '' },
                  previous: { enabled: input.type === 'previous' },
                  selected: { enabled: input.type === 'selected', items: input.selectedItems || [] }
                };
                return newFormat;
              }
              return input;
            });
          }
          
          if (mode === 'interactive') {
            showWorkflowExecutionModal(workflow);
          } else if (mode === 'straight') {
            $("#workflowResultContainer").html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Running entire workflow...</div>');
            
            runEntireWorkflow(workflow);
          }
        };
      } catch (error) {
        console.error("Error running workflow:", error);
        showNotification("Error: " + error.message, "danger");
      }
    }

    async function runEntireWorkflow(workflow) {
      let currentContent = "";
      let stepResults = [];
      
      try {
        for (let i = 0; i < workflow.steps.length; i++) {
          const step = workflow.steps[i];
          const configuredInput = workflow.configuredInputs && workflow.configuredInputs[i] 
            ? workflow.configuredInputs[i] 
            : { 
                custom: { enabled: true, content: '' },
                previous: { enabled: false },
                selected: { enabled: false, items: [] }
              };
          
          if (!step.actionId) {
            stepResults.push({
              step: i + 1,
              name: step.actionName || `Step ${i + 1}`,
              status: "skipped",
              message: "No action selected for this step"
            });
            continue;
          }
          
          $("#workflowResultContainer").html(`
            <div class="text-center">
              <i class="fas fa-spinner fa-spin"></i> 
              Running step ${i + 1} of ${workflow.steps.length}: ${step.actionName}...
            </div>
          `);
          
          let inputContent = [];
          
          if (configuredInput.custom && configuredInput.custom.enabled) {
            const customText = configuredInput.custom.content || $("#workflowTestInput").val().trim();
            if (customText) {
              inputContent.push({
                source: "Custom Input",
                content: customText
              });
            }
          }
          
          if (i > 0 && configuredInput.previous && configuredInput.previous.enabled && currentContent) {
            inputContent.push({
              source: "Previous Step Result",
              content: currentContent
            });
          }
          
          if (configuredInput.selected && configuredInput.selected.enabled && 
              configuredInput.selected.items && configuredInput.selected.items.length > 0) {
            try {
              const selectedContent = await assembleContentFromConfiguredItems(configuredInput.selected.items);
              if (selectedContent) {
                inputContent.push({
                  source: "Selected Content",
                  content: selectedContent
                });
              }
            } catch (error) {
              console.error("Error assembling content:", error);
            }
          }
          
          const combinedInput = inputContent.map(item => 
            `## ${item.source}\n${item.content}`
          ).join("\n\n---\n\n");
          
          const finalInput = combinedInput || "";
          
          const actionTx = db.transaction("actions", "readonly");
          const actionStore = actionTx.objectStore("actions");
          
          try {
            const getActionPromise = new Promise((resolve, reject) => {
              const request = actionStore.get(parseInt(step.actionId));
              request.onsuccess = function(e) {
                resolve(e.target.result);
              };
              request.onerror = function(e) {
                reject(e.target.error);
              };
            });
            
            const action = await getActionPromise;
            
            if (!action) {
              stepResults.push({
                step: i + 1,
                name: step.actionName || `Step ${i + 1}`,
                status: "error",
                message: "Action not found"
              });
              continue;
            }
            
            const processedPrompt = action.prompt.replace(/{content}/g, finalInput || "");
            
            const result = await callOpenAiApi(action, processedPrompt);
            
            currentContent = result;
            
            stepResults.push({
              step: i + 1,
              name: step.actionName || `Step ${i + 1}`,
              status: "success",
              result: result
            });
          } catch (error) {
            stepResults.push({
              step: i + 1,
              name: step.actionName || `Step ${i + 1}`,
              status: "error",
              message: error.message || "Error executing this step"
            });
            
            break;
          }
        }
        
        displayWorkflowResults(stepResults, currentContent);
        
      } catch (error) {
        $("#workflowResultContainer").html(`
          <div class="alert alert-danger">
            <strong>Error:</strong> ${error.message || "An error occurred while running the workflow"}
          </div>
        `);
      }
    }

    async function assembleContentFromConfiguredItems(selectedItems) {
      let contentParts = [];
      const blockFetchPromises = [];
      const paragraphFetchPromises = [];
      
      for (const item of selectedItems) {
        if (item.type === "block") {
          blockFetchPromises.push(
            new Promise((resolve, reject) => {
              const transaction = db.transaction("blocks", "readonly");
              const store = transaction.objectStore("blocks");
              
              store.get(parseInt(item.id)).onsuccess = function(e) {
                const block = e.target.result;
                if (block) {
                  const blockText = `## ${block.title || 'Block ' + block.id}\n${block.text}`;
                  resolve({
                    id: block.id,
                    text: blockText,
                    originalBlock: block
                  });
                } else {
                  reject(new Error(`Block with ID ${item.id} not found`));
                }
              };
            })
          );
        } else if (item.type === "paragraph") {
          paragraphFetchPromises.push(
            new Promise((resolve, reject) => {
              const transaction = db.transaction("documents", "readonly");
              const store = transaction.objectStore("documents");
              
              store.get(parseInt(item.docId)).onsuccess = function(e) {
                const doc = e.target.result;
                if (doc && doc.paragraphs && doc.paragraphs[item.paraIndex]) {
                  const para = doc.paragraphs[item.paraIndex];
                  const paraText = `## Paragraph ${parseInt(item.paraIndex) + 1} from ${doc.title}\n${para.content}`;
                  
                  const blockRefs = para.blockRefs || (para.blockRef ? [para.blockRef] : []);
                  const refBlockPromises = blockRefs.map(blockId => 
                    new Promise((resolveBlock) => {
                      const blockTx = db.transaction("blocks", "readonly");
                      const blockStore = blockTx.objectStore("blocks");
                      
                      blockStore.get(parseInt(blockId)).onsuccess = function(ev) {
                        const refBlock = ev.target.result;
                        if (refBlock) {
                          resolveBlock({
                            id: refBlock.id,
                            text: `### Referenced Block: ${refBlock.title || 'Block ' + refBlock.id}\n${refBlock.text}`,
                            originalBlock: refBlock
                          });
                        } else {
                          resolveBlock(null);
                        }
                      };
                    })
                  );
                  
                  Promise.all(refBlockPromises).then(refBlocks => {
                    const filteredRefBlocks = refBlocks.filter(b => b !== null);
                    resolve({
                      id: item.id,
                      text: paraText,
                      refBlocks: filteredRefBlocks
                    });
                  });
                } else {
                  reject(new Error(`Paragraph not found in document ${item.docId}`));
                }
              };
            })
          );
        }
      }
      
      const blocks = await Promise.all(blockFetchPromises);
      for (const block of blocks) {
        contentParts.push(block.text);
      }
      
      const paragraphs = await Promise.all(paragraphFetchPromises);
      for (const para of paragraphs) {
        contentParts.push(para.text);
        
        if (para.refBlocks && para.refBlocks.length) {
          for (const refBlock of para.refBlocks) {
            contentParts.push(refBlock.text);
          }
        }
      }
      
      return contentParts.join("\n\n---\n\n");
    }

    function showWorkflowExecutionModal(workflow) {
      if (!$('#workflow-execution-modal').length) {
        
        $('.copy-workflow-result-btn').click(function() {
          const result = $('#workflow-execution-modal').data('final-result');
          if (result) {
            copyTextToClipboard(result);
            showNotification("Final result copied to clipboard!");
          }
        });
        
        $('.save-workflow-result-btn').click(function() {
          const result = $('#workflow-execution-modal').data('final-result');
          if (result) {
            saveResultAsParagraph(result);
            $('#workflow-execution-modal').modal('hide');
          }
        });
        
        $('#save-workflow-config-btn').click(function() {
          const workflow = $('#workflow-execution-modal').data('current-workflow');
          if (workflow) {
            saveWorkflowConfiguration(workflow);
          }
        });
      }
      
      $('#workflow-execution-modal').data('current-workflow', workflow);
      
      $('#workflowExecutionModalLabel').text(`Configure & Execute: ${workflow.name}`);
      
      $('#workflow-steps-container').empty();
      $('#workflow-final-actions').addClass('d-none');
      
      workflow.steps.forEach((step, index) => {
        const isFirstStep = index === 0;
        const configuredInput = workflow.configuredInputs && workflow.configuredInputs[index] 
          ? workflow.configuredInputs[index] 
          : { 
              custom: { enabled: true, content: '' },
              previous: { enabled: false },
              selected: { enabled: false, items: [] }
            };
        
        const stepHtml = $(`
          <div class="card mb-3 workflow-step-card ${!isFirstStep ? 'disabled' : ''}" id="workflow-step-${index}-container" data-step-index="${index}">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Step ${index + 1}: ${step.actionName || "Unnamed Step"}</h6>
              <span class="step-status">
                ${isFirstStep ? '<span class="badge badge-secondary">Ready</span>' : '<span class="badge badge-light">Waiting</span>'}
              </span>
            </div>
            <div class="card-body">
              ${step.description ? `<p class="text-muted">${step.description}</p>` : ''}
              
              <div class="form-group">
                <label>Input for this step:</label>
                <p class="text-muted small">Select one or more input sources to combine for this step.</p>
                
                <div class="input-options-container">
                  <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" id="step-${index}-custom-checkbox" class="custom-control-input step-input-checkbox" 
                      data-input-type="custom" ${configuredInput.custom && configuredInput.custom.enabled ? 'checked' : ''}>
                    <label class="custom-control-label" for="step-${index}-custom-checkbox">Custom Input</label>
                  </div>
                
                  <textarea class="form-control mb-3" id="step-${index}-custom-input" rows="3" 
                    placeholder="Enter custom input for this step" 
                    ${!(configuredInput.custom && configuredInput.custom.enabled) ? 'disabled' : ''}>
                    ${configuredInput.custom && configuredInput.custom.content ? configuredInput.custom.content : 
                      (isFirstStep ? $('#workflowTestInput').val() : '')}
                  </textarea>
                  
                  ${!isFirstStep ? `
                  <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" id="step-${index}-previous-checkbox" class="custom-control-input step-input-checkbox" 
                      data-input-type="previous" ${configuredInput.previous && configuredInput.previous.enabled ? 'checked' : ''} 
                      ${isFirstStep ? 'disabled' : ''}>
                    <label class="custom-control-label" for="step-${index}-previous-checkbox">Use Previous Step Result</label>
                  </div>
                  
                  <div class="bg-light p-2 border rounded mb-3 previous-content-container ${!(configuredInput.previous && configuredInput.previous.enabled) ? 'd-none' : ''}">
                    <pre class="mb-0" id="step-${index}-previous-content"><em>Previous step hasn't been executed yet</em></pre>
                  </div>
                  ` : ''}
                  
                  <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" id="step-${index}-select-checkbox" class="custom-control-input step-input-checkbox" 
                      data-input-type="selected" ${configuredInput.selected && configuredInput.selected.enabled ? 'checked' : ''}>
                    <label class="custom-control-label" for="step-${index}-select-checkbox">Select Content from System</label>
                  </div>
                  
                  <div class="selected-content-container mb-3 ${!(configuredInput.selected && configuredInput.selected.enabled) ? 'd-none' : ''}">
                    <button class="btn btn-outline-primary select-content-btn" data-step-index="${index}">
                      <i class="fas fa-list"></i> Select Content Items
                    </button>
                    
                    <div class="mt-2 selected-items-summary">
                      ${configuredInput.selected && configuredInput.selected.items && configuredInput.selected.items.length ? 
                        `<small class="text-muted">${configuredInput.selected.items.length} item(s) selected</small>` : 
                        '<small class="text-muted">No items selected</small>'}
                    </div>
                  </div>
                </div>
                
                <button class="btn btn-primary" id="run-step-${index}-btn" ${!isFirstStep ? 'disabled' : ''}>
                  Execute Step ${index + 1}
                </button>
              </div>
              
              <div class="step-result"></div>
            </div>
          </div>
        `);
        
        stepHtml.find('.step-input-checkbox').change(function() {
          const inputType = $(this).data('input-type');
          const isChecked = $(this).prop('checked');
          
          if (inputType === 'custom') {
            $(`#step-${index}-custom-input`).prop('disabled', !isChecked);
          } else if (inputType === 'previous' && !isFirstStep) {
            const previousContainer = stepHtml.find('.previous-content-container');
            if (isChecked) {
              previousContainer.removeClass('d-none');
            } else {
              previousContainer.addClass('d-none');
            }
          } else if (inputType === 'selected') {
            const selectedContainer = stepHtml.find('.selected-content-container');
            if (isChecked) {
              selectedContainer.removeClass('d-none');
            } else {
              selectedContainer.addClass('d-none');
            }
          }
          
          updateStepConfiguration(index);
        });
        
        stepHtml.find('.select-content-btn').click(function() {
          const stepIndex = $(this).data('step-index');
          selectContentForStep(workflow, stepIndex);
        });
        
        stepHtml.find(`#run-step-${index}-btn`).click(async function() {
          let inputContent = [];
          
          if ($(`#step-${index}-custom-checkbox`).is(':checked')) {
            const customText = $(`#step-${index}-custom-input`).val().trim();
            if (customText) {
              inputContent.push({
                source: "Custom Input",
                content: customText
              });
            }
          }
          
          if (!isFirstStep && $(`#step-${index}-previous-checkbox`).is(':checked')) {
            const previousContent = $(`#step-${index}-previous-content`).data('content');
            if (previousContent) {
              inputContent.push({
                source: "Previous Step Result",
                content: previousContent
              });
            }
          }
          
          if ($(`#step-${index}-select-checkbox`).is(':checked')) {
            const configuredInput = workflow.configuredInputs && workflow.configuredInputs[index];
            if (configuredInput && configuredInput.selected && configuredInput.selected.items && configuredInput.selected.items.length > 0) {
              try {
                const selectedContent = await assembleContentFromConfiguredItems(configuredInput.selected.items);
                if (selectedContent) {
                  inputContent.push({
                    source: "Selected Content",
                    content: selectedContent
                  });
                }
              } catch (error) {
                console.error("Error assembling content:", error);
                showNotification("Error loading selected content: " + error.message, "danger");
                return;
              }
            } else if ($(`#step-${index}-select-checkbox`).is(':checked')) {
              showNotification("No content items selected", "warning");
              return;
            }
          }
          
          const combinedInput = inputContent.map(item => 
            `## ${item.source}\n${item.content}`
          ).join("\n\n---\n\n");
          console.log("Combined Input for Step " + (index + 1) + ":", combinedInput);
          
          await executeWorkflowStep(step, combinedInput, workflow, index);
        });
        
        $('#workflow-steps-container').append(stepHtml);
      });
      
      function updateStepConfiguration(stepIndex) {
        if (!workflow.configuredInputs) {
          workflow.configuredInputs = workflow.steps.map(() => ({ 
            custom: { enabled: true, content: '' },
            previous: { enabled: false },
            selected: { enabled: false, items: [] }
          }));
        }
        
        const isFirstStep = stepIndex === 0;
        
        const customCheckbox = $(`#step-${stepIndex}-custom-checkbox`);
        const customInput = $(`#step-${stepIndex}-custom-input`);
        const previousCheckbox = !isFirstStep ? $(`#step-${stepIndex}-previous-checkbox`) : null;
        const selectedCheckbox = $(`#step-${stepIndex}-select-checkbox`);
        
        workflow.configuredInputs[stepIndex] = {
          custom: {
            enabled: customCheckbox.is(':checked'),
            content: customInput.val().trim()
          },
          previous: {
            enabled: !isFirstStep && previousCheckbox ? previousCheckbox.is(':checked') : false
          },
          selected: {
            enabled: selectedCheckbox.is(':checked'),
            items: (workflow.configuredInputs[stepIndex] && 
                   workflow.configuredInputs[stepIndex].selected && 
                   workflow.configuredInputs[stepIndex].selected.items) || []
          }
        };
        
        $('#workflow-execution-modal').data('current-workflow', workflow);
      }
      
      $('#save-workflow-config-btn').off('click').on('click', function() {
        const workflow = $('#workflow-execution-modal').data('current-workflow');
        if (workflow) {
          workflow.steps.forEach((step, index) => {
            const customCheckbox = $(`#step-${index}-custom-checkbox`);
            const customInput = $(`#step-${index}-custom-input`);
            const isFirstStep = index === 0;
            const previousCheckbox = !isFirstStep ? $(`#step-${index}-previous-checkbox`) : null;
            const selectedCheckbox = $(`#step-${index}-select-checkbox`);
            
            if (!workflow.configuredInputs) {
              workflow.configuredInputs = [];
            }
            
            if (!workflow.configuredInputs[index]) {
              workflow.configuredInputs[index] = {
                custom: { enabled: true, content: '' },
                previous: { enabled: false },
                selected: { enabled: false, items: [] }
              };
            }
            
            workflow.configuredInputs[index].custom = {
              enabled: customCheckbox.is(':checked'),
              content: customInput.val().trim()
            };
            
            if (!isFirstStep && previousCheckbox) {
              workflow.configuredInputs[index].previous = {
                enabled: previousCheckbox.is(':checked')
              };
            }
            
            workflow.configuredInputs[index].selected = {
              enabled: selectedCheckbox.is(':checked'),
              items: (workflow.configuredInputs[index] && 
                     workflow.configuredInputs[index].selected && 
                     workflow.configuredInputs[index].selected.items) || []
            };
          });
          
          saveWorkflowConfiguration(workflow);
        }
      });
      
      $('#workflow-execution-modal').modal('show');
    }

    function selectContentForStep(workflow, stepIndex) {
      selectedContentItems = (workflow.configuredInputs && 
                            workflow.configuredInputs[stepIndex] && 
                            workflow.configuredInputs[stepIndex].selected &&
                            workflow.configuredInputs[stepIndex].selected.items) || [];
                            
      $("#contentSelectionModalLabel").text("Select Content for Workflow Step");
      $(".action-selection-info").text("Select items to use as input for this workflow step");
      $("#contentSelectionModal").data("workflow-step-index", stepIndex);
      $("#contentSelectionModal").data("selection-mode", "multiple");
      
      $("#confirmContentSelection").text("Use Selected Items").off("click").on("click", function() {
        if (!workflow.configuredInputs) {
          workflow.configuredInputs = workflow.steps.map(() => ({ 
            custom: { enabled: true, content: '' },
            previous: { enabled: false },
            selected: { enabled: false, items: [] }
          }));
        }
        
        if (!workflow.configuredInputs[stepIndex]) {
          workflow.configuredInputs[stepIndex] = {
            custom: { enabled: true, content: '' },
            previous: { enabled: false },
            selected: { enabled: true, items: selectedContentItems }
          };
        } else {
          workflow.configuredInputs[stepIndex].selected = { 
            enabled: true,
            items: selectedContentItems 
          };
        }
        
        $('#workflow-execution-modal').data('current-workflow', workflow);
        
        $(`#workflow-step-${stepIndex}-container .selected-items-summary`).html(
          `<small class="text-muted">${selectedContentItems.length} item(s) selected</small>`
        );
        
        $("#contentSelectionModal").modal("hide");
      });
      
      loadBlocksForSelection();
      loadDocumentsForSelection();
      loadTagsForSelection();
      loadReferencesForSelection();
      
      $("#contentSelectionModal").modal("show");
    }

    async function executeWorkflowStep(step, inputContent, workflow, stepIndex) {
      const stepContainer = $(`#workflow-step-${stepIndex}-container`);
      
      stepContainer.find('.step-status')
        .html('<span class="badge badge-info"><i class="fas fa-spinner fa-spin"></i> Running...</span>');
      
      try {
        const actionTx = db.transaction("actions", "readonly");
        const actionStore = actionTx.objectStore("actions");
        
        const getActionPromise = new Promise((resolve, reject) => {
          const request = actionStore.get(parseInt(step.actionId));
          request.onsuccess = function(e) {
            resolve(e.target.result);
          };
          request.onerror = function(e) {
            reject(e.target.error);
          };
        });
        
        const action = await getActionPromise;
        
        if (!action) {
          stepContainer.find('.step-status')
            .html('<span class="badge badge-danger">Error: Action not found</span>');
          return { status: "error", message: "Action not found" };
        }
        
        const processedPrompt = action.prompt.replace(/{content}/g, inputContent || "");
        
        const result = await callOpenAiApi(action, processedPrompt);
        
        stepContainer.find('.step-status')
          .html('<span class="badge badge-success">Success</span>');
        
        const resultContainer = stepContainer.find('.step-result');
        resultContainer.html(`
          <div class="card mt-2">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Result</span>
              <div>
                <button class="btn btn-sm btn-outline-primary copy-step-result-btn">
                  <i class="fas fa-copy"></i> Copy
                </button>
                <button class="btn btn-sm btn-outline-secondary toggle-step-result-btn">
                  <i class="fas fa-eye-slash"></i> Hide
                </button>
              </div>
            </div>
            <div class="card-body step-result-content">
              <div class="bg-light p-2 border rounded result-content">${marked.parse(result)}</div>
            </div>
          </div>
        `);
        
        resultContainer.find('.toggle-step-result-btn').click(function() {
          const resultContent = $(this).closest('.card').find('.step-result-content');
          const btn = $(this);
          
          if (resultContent.is(':visible')) {
            resultContent.slideUp();
            btn.html('<i class="fas fa-eye"></i> Show');
          } else {
            resultContent.slideDown();
            btn.html('<i class="fas fa-eye-slash"></i> Hide');
          }
        });
        
        resultContainer.find('.copy-step-result-btn').click(function() {
          copyTextToClipboard(result);
          showNotification("Step result copied to clipboard!");
        });
        
        const nextStepIndex = stepIndex + 1;
        if (nextStepIndex < workflow.steps.length) {
          $(`#workflow-step-${nextStepIndex}-container`).removeClass('disabled');
          $(`#run-step-${nextStepIndex}-btn`).prop('disabled', false);
          
          const nextInputRadio = $(`#step-${nextStepIndex}-previous-radio`);
          nextInputRadio.prop('checked', true);
          $(`#step-${nextStepIndex}-custom-input`).prop('disabled', true);
          $(`#step-${nextStepIndex}-previous-content`).text(result).data('content', result);
        }
        
        if (nextStepIndex === workflow.steps.length) {
          $('#workflow-final-actions').removeClass('d-none');
          $('#workflow-execution-modal').data('final-result', result);
        }
        
        return { status: "success", result: result };
      } catch (error) {
        console.error("Step execution error:", error);
        stepContainer.find('.step-status')
          .html(`<span class="badge badge-danger">Error: ${error.message || "Execution failed"}</span>`);
        return { status: "error", message: error.message || "Error executing this step" };
      }
    }

    function displayWorkflowResults(stepResults, finalResult) {
      let html = '<div class="card"><div class="card-header">Workflow Results</div><div class="card-body">';
      
      stepResults.forEach(result => {
        html += `<div class="mb-3">
          <h6>Step ${result.step}: ${result.name}</h6>
          <p>Status: <span class="badge badge-${result.status === 'success' ? 'success' : 'danger'}">${result.status}</span></p>
          ${result.result ? `<div class="bg-light p-2 border rounded">${marked.parse(result.result)}</div>` : ''}
          ${result.message ? `<p class="text-danger">${result.message}</p>` : ''}
        </div>`;
      });
      
      html += `<div class="mt-3">
        <h5>Final Result:</h5>
        <div class="bg-light p-2 border rounded">${marked.parse(finalResult)}</div>
      </div>`;
      
      html += '</div></div>';
      $("#workflowResultContainer").html(html);
    }

    function saveWorkflowConfiguration(workflow) {
      const transaction = db.transaction("workflows", "readwrite");
      const store = transaction.objectStore("workflows");
      
      store.get(workflow.id).onsuccess = function(e) {
        const existingWorkflow = e.target.result;
        if (existingWorkflow) {
          existingWorkflow.configuredInputs = workflow.configuredInputs;
          existingWorkflow.updated = new Date();
          
          store.put(existingWorkflow).onsuccess = function() {
            showNotification("Workflow configuration saved successfully!");
          };
        } else {
          showNotification("Could not find workflow to save configuration", "warning");
        }
      };
    }

    function editWorkflow(workflow) {
      editingWorkflowId = workflow.id;
      $("#workflowName").val(workflow.name);
      $("#workflowDesc").val(workflow.description || "");
      $("#workflowSteps").empty();

      workflow.steps.forEach((step, index) => {
        const stepHtml = $(`
          <div class="workflow-step mb-3">
            <div class="form-group">
              <label>Step ${index + 1} Name</label>
              <input type="text" class="form-control step-name" value="${step.actionName || ''}" placeholder="Enter step name">
            </div>
            <div class="form-group">
              <label>Step ${index + 1} Description</label>
              <textarea class="form-control step-desc" rows="2" placeholder="Enter step description">${step.description || ''}</textarea>
            </div>
            <div class="form-group">
              <label>Action</label>
              <select class="form-control step-action-id">
                <option value="">Select an action...</option>
              </select>
              <small class="form-text text-muted">If no actions are listed, ensure actions are created in the Actions tab.</small>
            </div>
            <button type="button" class="btn btn-danger btn-sm remove-step-btn">Remove Step</button>
          </div>
        `);

        const transaction = db.transaction("actions", "readonly");
        const store = transaction.objectStore("actions");
        store.openCursor().onsuccess = function (e) {
          const cursor = e.target.result;
          if (cursor) {
            const action = cursor.value;
            stepHtml.find(".step-action-id").append(
              `<option value="${action.id}" ${action.id === step.actionId ? 'selected' : ''}>${action.title}</option>`
            );
            cursor.continue();
          }
        };

        stepHtml.find(".remove-step-btn").click(function () {
          stepHtml.remove();
        });

        $("#workflowSteps").append(stepHtml);
      });

      $("#workflowForm button[type=submit]").text("Update Workflow");
    }

    $("#addWorkflowStepBtn").on("click", function () {
      const stepHtml = $(`
        <div class="workflow-step mb-3">
          <div class="form-group">
            <label>Step Name</label>
            <input type="text" class="form-control step-name" placeholder="Enter step name">
          </div>
          <div class="form-group">
            <label>Step Description</label>
            <textarea class="form-control step-desc" rows="2" placeholder="Enter step description"></textarea>
          </div>
          <div class="form-group">
            <label>Action</label>
            <select class="form-control step-action-id">
              <option value="">Select an action...</option>
            </select>
            <small class="form-text text-muted">If no actions are listed, ensure actions are created in the Actions tab.</small>
          </div>
          <button type="button" class="btn btn-danger btn-sm remove-step-btn">Remove Step</button>
        </div>
      `);

      const transaction = db.transaction("actions", "readonly");
      const store = transaction.objectStore("actions");
      store.openCursor().onsuccess = function (e) {
        const cursor = e.target.result;
        if (cursor) {
          const action = cursor.value;
          stepHtml.find(".step-action-id").append(
            `<option value="${action.id}">${action.title}</option>`
          );
          cursor.continue();
        }
      };

      stepHtml.find(".remove-step-btn").click(function () {
        stepHtml.remove();
      });

      $("#workflowSteps").append(stepHtml);
    });

    $("#workflowForm").on("submit", function(e) {
      e.preventDefault();
      
      const name = $("#workflowName").val().trim();
      const description = $("#workflowDesc").val().trim();
      
      if (!name) {
        showNotification("Workflow name is required", "warning");
        return;
      }
      
      const steps = [];
      $(".workflow-step").each(function() {
        const actionName = $(this).find(".step-name").val().trim();
        const description = $(this).find(".step-desc").val().trim();
        const actionId = parseInt($(this).find(".step-action-id").val());
        
        if (actionName) {
          steps.push({
            actionName,
            description,
            actionId: isNaN(actionId) ? null : actionId
          });
        }
      });
      
      const transaction = db.transaction("workflows", "readwrite");
      const store = transaction.objectStore("workflows");
      
      if (editingWorkflowId) {
        store.get(editingWorkflowId).onsuccess = function(e) {
          const workflow = e.target.result;
          workflow.name = name;
          workflow.description = description;
          workflow.steps = steps;
          workflow.updated = new Date();
          
          store.put(workflow).onsuccess = function() {
            showNotification("Workflow updated successfully!");
            resetWorkflowForm();
            loadWorkflows();
          };
        };
      } else {
        const workflow = {
          name,
          description,
          steps,
          created: new Date()
        };
        
        store.add(workflow).onsuccess = function() {
          showNotification("New workflow created!");
          resetWorkflowForm();
          loadWorkflows();
        };
      }
    });

    function deleteWorkflow(id) {
      if (confirm("Are you sure you want to delete this workflow?")) {
        const transaction = db.transaction("workflows", "readwrite");
        const store = transaction.objectStore("workflows");
        store.delete(id).onsuccess = function () {
          loadWorkflows();
          showNotification("Workflow deleted successfully!");
          if (editingWorkflowId === id) {
            resetWorkflowForm();
          }
        };
      }
    }

    function resetWorkflowForm() {
      editingWorkflowId = null;
      $("#workflowForm")[0].reset();
      $("#workflowSteps").empty();
      $("#workflowForm button[type=submit]").text("Save Workflow");
    }

    /**********************
     * Collections Management
     **********************/
    let editingCollectionId = null;
    let collectionItems = [];

    function loadCollections(searchTerm = "") {
      $("#collectionList").empty();
      const transaction = db.transaction("collections", "readonly");
      const store = transaction.objectStore("collections");
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const collection = cursor.value;
          const searchableText = (collection.name + " " + collection.description + " " + collection.tags.join(" ")).toLowerCase();
          
          if (!searchTerm || searchableText.includes(searchTerm.toLowerCase())) {
            const li = $("<li>")
              .addClass("list-group-item list-item")
              .html(`
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${collection.name}</strong>
                    <br><small>${collection.description || ""}</small>
                    ${collection.tags.map(t => `<span class="badge badge-info mr-1">${t}</span>`).join("")}
                  </div>
                </div>
              `);

            li.click(() => previewCollection(collection));
            $("#collectionList").append(li);
          }
          cursor.continue();
        }
      };
    }

    function editCollection(collection) {
      editingCollectionId = collection.id;
      $("#collectionName").val(collection.name);
      $("#collectionDesc").val(collection.description || "");
      $("#collectionTags").val(collection.tags.join(", "));
      collectionItems = [...collection.items];
      updateCollectionItemsUI();
    }

    function deleteCollection(id) {
      if (confirm("Are you sure you want to delete this collection?")) {
        const transaction = db.transaction("collections", "readwrite");
        const store = transaction.objectStore("collections");
        store.delete(id).onsuccess = function() {
          loadCollections();
          if (editingCollectionId === id) {
            resetCollectionForm();
          }
          showNotification("Collection deleted successfully!");
        };
      }
    }

    function resetCollectionForm() {
      editingCollectionId = null;
      collectionItems = [];
      $("#collectionForm")[0].reset();
      updateCollectionItemsUI();
    }

    function updateCollectionItemsUI() {
      const container = $("#collectionItems");
      if (collectionItems.length === 0) {
        container.html('<p class="text-muted text-center mb-0">No items added yet</p>');
        return;
      }

      let html = '<ul class="list-group">';
      collectionItems.forEach((item, index) => {
        html += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            ${item.type === 'block' ? '<i class="fas fa-cube"></i>' : '<i class="fas fa-file-alt"></i>'}
            ${item.title}
            <button class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">
              <i class="fas fa-times"></i>
            </button>
          </li>
        `;
      });
      html += '</ul>';
      container.html(html);

      $(".remove-item-btn").click(function() {
        const index = $(this).data("index");
        collectionItems.splice(index, 1);
        updateCollectionItemsUI();
      });
    }

    $("#addBlockToCollection").click(function() {
      const selectDialog = $(`
        <div class="modal fade" id="selectBlockModal">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Select Blocks</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body">
                <input type="text" class="form-control mb-3" id="blockSearchInput" placeholder="Search blocks...">
                <div id="blockSelectionList"></div>
              </div>
            </div>
          </div>
        </div>
      `).appendTo('body');

      loadBlocksForCollection();
      selectDialog.modal('show');

      selectDialog.on('hidden.bs.modal', function() {
        selectDialog.remove();
      });
    });

    $("#addDocToCollection").click(function() {
      const selectDialog = $(`
        <div class="modal fade" id="selectDocModal">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Select Documents</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body">
                <input type="text" class="form-control mb-3" id="docSearchInput" placeholder="Search documents...">
                <div id="docSelectionList"></div>
              </div>
            </div>
          </div>
        </div>
      `).appendTo('body');

      loadDocsForCollection();
      selectDialog.modal('show');

      selectDialog.on('hidden.bs.modal', function() {
        selectDialog.remove();
      });
    });

    function loadBlocksForCollection(searchTerm = "") {
      const list = $("#blockSelectionList");
      list.empty();

      const transaction = db.transaction("blocks", "readonly");
      const store = transaction.objectStore("blocks");
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const block = cursor.value;
          if (!searchTerm || block.title.toLowerCase().includes(searchTerm.toLowerCase())) {
            const item = $(`
              <div class="card mb-2">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6>${block.title || 'Block ' + block.id}</h6>
                      <small>${block.text.substring(0, 100)}...</small>
                    </div>
                    <button class="btn btn-sm btn-primary add-block-btn">Add</button>
                  </div>
                </div>
              </div>
            `);

            item.find(".add-block-btn").click(() => {
              collectionItems.push({
                type: 'block',
                id: block.id,
                title: block.title || 'Block ' + block.id
              });
              updateCollectionItemsUI();
              $("#selectBlockModal").modal('hide');
            });

            list.append(item);
          }
          cursor.continue();
        }
      };
    }

    function loadDocsForCollection(searchTerm = "") {
      const list = $("#docSelectionList");
      list.empty();

      const transaction = db.transaction("documents", "readonly");
      const store = transaction.objectStore("documents");
      
      store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const doc = cursor.value;
          if (!searchTerm || doc.title.toLowerCase().includes(searchTerm.toLowerCase())) {
            const item = $(`
              <div class="card mb-2">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6>${doc.title}</h6>
                      <small>${doc.paragraphs.length} paragraphs</small>
                    </div>
                    <button class="btn btn-sm btn-primary add-doc-btn">Add</button>
                  </div>
                </div>
              </div>
            `);

            item.find(".add-doc-btn").click(() => {
              collectionItems.push({
                type: 'document',
                id: doc.id,
                title: doc.title
              });
              updateCollectionItemsUI();
              $("#selectDocModal").modal('hide');
            });

            list.append(item);
          }
          cursor.continue();
        }
      };
    }

    $("#collectionForm").on("submit", function(e) {
      e.preventDefault();
      
      const name = $("#collectionName").val().trim();
      const description = $("#collectionDesc").val().trim();
      const tags = $("#collectionTags").val().split(",").map(t => t.trim()).filter(t => t);
      
      const collection = {
        name,
        description,
        tags,
        items: collectionItems,
        updated: new Date()
      };

      const transaction = db.transaction("collections", "readwrite");
      const store = transaction.objectStore("collections");

      if (editingCollectionId) {
        collection.id = editingCollectionId;
        store.put(collection).onsuccess = function() {
          showNotification("Collection updated successfully!");
          resetCollectionForm();
          loadCollections();
        };
      } else {
        store.add(collection).onsuccess = function() {
          showNotification("Collection created successfully!");
          resetCollectionForm();
          loadCollections();
        };
      }
    });

    $("#cancelCollectionBtn").click(resetCollectionForm);

    $("#collectionSearch").on("keyup", function() {
      loadCollections($(this).val().trim());
    });

    function previewCollection(collection) {
      let html = `
        <div class="card-header">${collection.name}
          <div class="btn-group float-right">
            <button class="btn btn-sm btn-warning edit-collection-btn">Edit</button>
            <button class="btn btn-sm btn-danger delete-collection-btn">Delete</button>
          </div>
        </div>
        ${collection.description ? `<p>${collection.description}</p>` : ''}
        ${collection.tags.length ? `
          <div class="mb-3">
            ${collection.tags.map(t => `<span class="badge badge-info mr-1">${t}</span>`).join('')}
          </div>
        ` : ''}
      `;

      if (collection.items.length === 0) {
        html += '<p class="text-muted">This collection is empty.</p>';
      } else {
        html += '<div class="list-group">';
        collection.items.forEach(item => {
          html += `
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  ${item.title}
                  ${item.type === 'block' ? '<i class="fas fa-cube mr-2">block</i>' : '<i class="fas fa-file-alt mr-2">document</i>'}
                </div>
                <button class="btn btn-sm btn-outline-primary preview-item-btn" 
                  data-type="${item.type}" data-id="${item.id}">
                  Preview
                </button>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      $("#collectionPreview").html(html);

        // Set up close button handler
        $(".delete-collection-btn").on("click", function(e) {
          e.stopPropagation();
          deleteCollection(collection.id);
      });
      
      // Set up edit button handler
      $(".edit-collection-btn").on("click", function(e) {
        e.stopPropagation();
        editCollection(collection);
      });

      // Add preview handlers
      $(".preview-item-btn").click(function() {
        const type = $(this).data("type");
        const id = $(this).data("id");
        // debug
        console.log("Previewing item of type:", type, "with ID:", id);
        if (type === "block") {
          
          fetchBlockById(id, function(block) {
            if (block) 
            // go to blocks tab and show block details, the id is blocks-tab
            $("#blocks-tab").click();
            showBlockDetails(block);
          });
        } else {
          fetchDocumentById(id, function(doc) {
            if (doc) 
            $("#documents-tab").click();
            previewDocument(doc);
          });
        }
      });
    }

    // Initialize collections on page load
    $(document).ready(function() {
      loadCollections();
    });
  </script>
</body>
</html>
